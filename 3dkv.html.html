<html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary School Karanpur - Report Card System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap');
        
        * {
            font-family: 'Comic Neue', cursive;
        }
        
        .marquee {
            position: fixed;
            width: 100%;
            z-index: 1000;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .marquee-top {
            top: 0;
            background: linear-gradient(45deg, #fbbf24 0%, #f59e0b 50%, #ec4899 100%);
            animation: colorShift 8s ease-in-out infinite;
        }
        
        .marquee-bottom {
            bottom: 0;
            background: linear-gradient(45deg, #34d399 0%, #10b981 50%, #3b82f6 100%);
            animation: colorShift 10s ease-in-out infinite reverse;
        }
        
        .marquee-content {
            display: inline-block;
            animation: scroll 20s linear infinite;
            padding: 15px 0;
            color: #ffffff;
            font-weight: bold;
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .shape:nth-child(1) { left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { left: 20%; animation-delay: 1s; }
        .shape:nth-child(3) { left: 30%; animation-delay: 2s; }
        .shape:nth-child(4) { left: 40%; animation-delay: 3s; }
        .shape:nth-child(5) { left: 50%; animation-delay: 4s; }
        .shape:nth-child(6) { left: 60%; animation-delay: 5s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        @keyframes colorShift {
            0% { 
                filter: hue-rotate(0deg) brightness(1) saturate(1);
            }
            25% { 
                filter: hue-rotate(90deg) brightness(1.1) saturate(1.2);
            }
            50% { 
                filter: hue-rotate(180deg) brightness(1.2) saturate(1.4);
            }
            75% { 
                filter: hue-rotate(270deg) brightness(1.1) saturate(1.2);
            }
            100% { 
                filter: hue-rotate(360deg) brightness(1) saturate(1);
            }
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f39c12;
            animation: confetti-fall 3s linear infinite;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-gradient {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .admin-gradient {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        body {
            padding-top: 60px;
            padding-bottom: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .message {
            transition: all 0.3s ease;
            transform: translateY(-10px);
            opacity: 0;
        }
        
        .message.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .error-input {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        
        .success-input {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
        }
        
        .quote-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            to { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }
        
        /* Big Trophy Animation Styles */
        
        
        @keyframes messageGlow {
            from { 
                text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px rgba(255, 215, 0, 0.5);
            }
            to { 
                text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 40px rgba(255, 215, 0, 1);
            }
        }
        
        /* Additional Instructions Animations */
        .animate-fade-in {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .animate-pulse-gentle {
            animation: pulseGentle 3s ease-in-out infinite;
        }
        
        .animate-bounce-subtle {
            animation: bounceSubtle 2s ease-in-out infinite;
        }
        
        .animate-slide-in {
            animation: slideInFromLeft 1s ease-out;
        }
        
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulseGentle {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(147, 51, 234, 0);
            }
        }
        
        @keyframes bounceSubtle {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        @keyframes slideInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        

    </style>
</head>
<body>
    <!-- Top Marquee -->
    <div class="marquee marquee-top">
        <div class="floating-shapes">
            <div class="shape w-8 h-8 bg-yellow-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-pink-300 transform rotate-45"></div>
            <div class="shape w-10 h-10 bg-green-300 rounded-full"></div>
            <div class="shape w-8 h-8 bg-blue-300 transform rotate-45"></div>
            <div class="shape w-6 h-6 bg-purple-300 rounded-full"></div>
            <div class="shape w-8 h-8 bg-red-300 transform rotate-45"></div>
        </div>
        <div class="marquee-content">
            ğŸŒŸ Welcome to Primary School Karanpur, A place where students learn with joy..!! ğŸŒŸ
        </div>
    </div>

    <!-- Bottom Marquee -->
    <div class="marquee marquee-bottom">
        <div class="floating-shapes">
            <div class="shape w-8 h-8 bg-yellow-300 rounded-full"></div>
            <div class="shape w-6 h-6 bg-pink-300 transform rotate-45"></div>
            <div class="shape w-10 h-10 bg-green-300 rounded-full"></div>
            <div class="shape w-8 h-8 bg-blue-300 transform rotate-45"></div>
            <div class="shape w-6 h-6 bg-purple-300 rounded-full"></div>
            <div class="shape w-8 h-8 bg-red-300 transform rotate-45"></div>
        </div>
        <div class="marquee-content">
            ğŸ’ This site is developed by Mr. Deepak Kumar Vaishya, Assistant Teacher at Primary School Karanpur, Behjam-Kheri and dedicated to the loving students..!! ğŸ’
        </div>
    </div>

    <!-- Celebration Animation Container -->
    <div id="celebration" class="celebration hidden"></div>
    
    <!-- Big Trophy Celebration Container -->
    <div id="trophyCelebration" class="trophy-celebration hidden">
        <button class="trophy-close" onclick="closeTrophyCelebration()">Ã—</button>
        <div class="trophy-container">
            <div class="trophy-sparkles" id="trophySparkles"></div>
            <div class="big-trophy">ğŸ†</div>
            <div class="trophy-message" id="trophyMessage">OUTSTANDING PERFORMANCE!</div>
            <div class="trophy-percentage" id="trophyPercentage">95.5%</div>
            <div style="color: #FFF; font-size: 1.5rem; margin-top: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                ğŸŒŸ You're a Champion! ğŸŒŸ
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- School Information Tile -->
        <div class="w-full max-w-5xl mx-auto mb-8 bounce-in">
            <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 lg:p-10 border-4 border-gradient-to-r from-yellow-400 to-orange-500" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-image: linear-gradient(45deg, #fbbf24, #f97316) 1;">
                <div class="text-center">
                    <!-- School Name -->
                    <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl xl:text-8xl 2xl:text-9xl font-bold mb-6 bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent leading-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1); line-height: 0.9;">
                        Primary School Karanpur
                    </h1>
                    
                    <!-- Location Information -->
                    <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-2xl p-4 md:p-6 shadow-lg border-2 border-dashed border-blue-300">
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl md:text-3xl">ğŸ“</span>
                                <span class="text-lg md:text-xl lg:text-2xl font-bold text-blue-700">Block: Behjam</span>
                            </div>
                            <div class="hidden sm:block text-blue-500 text-2xl">â€¢</div>
                            <div class="flex items-center gap-2">
                                <span class="text-2xl md:text-3xl">ğŸ›ï¸</span>
                                <span class="text-lg md:text-xl lg:text-2xl font-bold text-purple-700">District: Lakhimpur-Kheri</span>
                            </div>
                        </div>
                        
                        <!-- Additional School Info -->
                        <div class="mt-4 pt-4 border-t-2 border-dashed border-gray-300">
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-6 text-sm md:text-base lg:text-lg">
                                <div class="flex items-center gap-2 text-green-700 font-semibold">
                                    <span class="text-xl">ğŸ“</span>
                                    <span>Classes 1-5</span>
                                </div>
                                <div class="hidden sm:block text-gray-400">|</div>
                                <div class="flex items-center gap-2 text-orange-700 font-semibold">
                                    <span class="text-xl">ğŸ“š</span>
                                    <span>Quality Education</span>
                                </div>
                                <div class="hidden sm:block text-gray-400">|</div>
                                <div class="flex items-center gap-2 text-pink-700 font-semibold">
                                    <span class="text-xl">ğŸŒŸ</span>
                                    <span>Bright Future</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Decorative Elements -->
                    <div class="mt-6 flex justify-center gap-4">
                        <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        <div class="w-3 h-3 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 0.6s;"></div>
                        <div class="w-3 h-3 bg-purple-400 rounded-full animate-pulse" style="animation-delay: 0.8s;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-center gap-4 mb-8">
            <button id="studentBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 pulse-button">
                ğŸ‘¨â€ğŸ“ Student Portal
            </button>
            <button id="adminBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 pulse-button">
                ğŸ‘¨â€ğŸ’¼ Admin Panel
            </button>
        </div>

        <!-- Student Portal -->
        <div id="studentPortal" class="max-w-4xl mx-auto">
            <div class="card-gradient rounded-3xl shadow-2xl p-8 mb-8 bounce-in">
                <h2 class="text-3xl font-bold text-white text-center mb-6">ğŸ“‹ Student Report Card</h2>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Class Selection -->
                    <div class="bg-white rounded-2xl p-4 shadow-lg">
                        <label class="block text-purple-700 font-bold mb-2">ğŸ“ Select Class:</label>
                        <select id="classSelect" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none">
                            <option value="">Choose Class</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                        </select>
                    </div>
                    
                    <!-- Student Selection -->
                    <div class="bg-white rounded-2xl p-4 shadow-lg">
                        <label class="block text-purple-700 font-bold mb-2">ğŸ‘¦ Select Student:</label>
                        <select id="studentSelect" class="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none" disabled>
                            <option value="">Choose Student</option>
                        </select>
                    </div>
                </div>
                
                <!-- Active Term Display -->
                <div id="activeTermDisplay" class="bg-gradient-to-r from-indigo-100 to-purple-100 rounded-2xl p-6 mb-6 text-center shadow-lg border-2 border-dashed border-indigo-300">
                    <h3 id="studentTileTitle" class="text-2xl md:text-3xl font-bold text-indigo-700 mb-3">ğŸ“… Currently Viewing Term</h3>
                    <p id="activeTermName" class="text-3xl md:text-4xl font-bold text-purple-800 mb-3"></p>
                    <p id="studentMessage" class="text-lg md:text-xl text-indigo-600 mt-3 font-semibold"></p>
                    <div id="additionalInstructionsDiv" class="hidden mt-6 p-4 bg-white rounded-xl border-2 border-dashed border-purple-300 animate-fade-in">
                        <div class="animate-pulse-gentle">
                            <p id="additionalInstructionsText" class="text-lg md:text-xl text-purple-700 font-semibold leading-relaxed animate-slide-in"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Card Display -->
            <div id="reportCard" class="hidden bg-white rounded-3xl shadow-2xl p-8 bounce-in">
                <div class="text-center mb-6">
                    <h3 class="text-3xl font-bold text-purple-700 mb-2">ğŸ† Report Card</h3>
                    <div id="studentInfoTile" class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-6 mb-4 shadow-lg">
                        <div id="studentInfo" class="text-lg text-gray-700"></div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border-2 border-purple-300 rounded-lg overflow-hidden">
                        <thead class="bg-purple-500 text-white">
                            <tr>
                                <th class="border-2 border-purple-300 p-3 text-left">ğŸ“š Subject</th>
                                <th class="border-2 border-purple-300 p-3 text-center">ğŸ“Š Marks Obtained</th>
                                <th class="border-2 border-purple-300 p-3 text-center">ğŸ¯ Maximum Marks</th>
                            </tr>
                        </thead>
                        <tbody id="marksTable">
                        </tbody>
                    </table>
                </div>
                
                <!-- Absence Information -->
                <div id="absenceInfo" class="mt-6 hidden"></div>
                
                <div id="summary" class="mt-6 grid md:grid-cols-2 gap-4">
                    <div class="bg-blue-100 rounded-2xl p-4 text-center">
                        <h4 class="text-xl font-bold text-blue-700">ğŸ“ˆ Percentage</h4>
                        <p id="percentage" class="text-3xl font-bold text-blue-800"></p>
                    </div>
                    <div class="bg-yellow-100 rounded-2xl p-4 text-center">
                        <h4 class="text-xl font-bold text-yellow-700">ğŸ… Rank</h4>
                        <p id="rank" class="text-3xl font-bold text-yellow-800"></p>
                    </div>
                </div>
                
                <!-- Motivational Quote -->
                <div id="motivationalQuote" class="mt-6"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden max-w-6xl mx-auto">
            <!-- Admin Login -->
            <div id="adminLogin" class="admin-gradient rounded-3xl shadow-2xl p-8 mb-8 bounce-in">
                <h2 class="text-3xl font-bold text-white text-center mb-6">ğŸ” Admin Login</h2>
                <div class="max-w-md mx-auto">
                    <input type="password" id="adminPassword" placeholder="Enter Admin Password" class="w-full p-4 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none mb-4">
                    <button id="loginBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                        ğŸšª Login
                    </button>
                    <div id="loginMessage" class="message mt-2 text-center font-bold"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="admin-gradient rounded-3xl shadow-2xl p-8 mb-8">
                    <h2 class="text-3xl font-bold text-white text-center mb-6">âš™ï¸ Admin Dashboard</h2>
                    
                    <!-- Student View Control -->
                    <div class="bg-gradient-to-r from-green-100 to-emerald-100 rounded-2xl p-6 mb-6 shadow-lg border-2 border-green-300">
                        <h3 class="text-xl font-bold text-green-700 mb-4 text-center">ğŸ¯ Control Student View & Messages</h3>
                        
                        <!-- Term Selection -->
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-green-700 font-bold mb-2">ğŸ“… Set Active Term for Students:</label>
                                <select id="studentViewTermSelect" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none">
                                    <option value="">No term visible to students</option>
                                    <option value="term1">Term 1</option>
                                    <option value="term2">Term 2</option>
                                    <option value="term3">Term 3</option>
                                    <option value="combined">ğŸŒŸ All Terms Combined</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="setActiveTermBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ¯ Set Active Term
                                </button>
                            </div>
                        </div>
                        
                        <!-- Custom Message Configuration -->
                        <div class="bg-white rounded-xl p-4 mb-4 border-2 border-dashed border-blue-300">
                            <h4 class="text-lg font-bold text-blue-700 mb-3">âœï¸ Customize Student Message Tile</h4>
                            <div class="grid md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <label class="block text-blue-700 font-semibold mb-2">ğŸ·ï¸ Tile Title:</label>
                                    <input type="text" id="customTileTitle" placeholder="ğŸ“… Currently Viewing Term" 
                                           class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                           value="ğŸ“… Currently Viewing Term">
                                </div>
                                <div>
                                    <label class="block text-blue-700 font-semibold mb-2">ğŸ’¬ Custom Message:</label>
                                    <input type="text" id="customMessage" placeholder="Enter your custom message for students" 
                                           class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                           value="">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-blue-700 font-semibold mb-2">ğŸ“ Additional Instructions (Optional):</label>
                                <textarea id="additionalInstructions" placeholder="Enter any additional instructions for students..." 
                                          class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none h-20 resize-none"></textarea>
                            </div>
                            <div class="grid md:grid-cols-3 gap-2">
                                <button onclick="setQuickMessage('Results are being prepared', 'Please wait while we finalize your marks')" 
                                        class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                    â³ Results Preparing
                                </button>
                                <button onclick="setQuickMessage('Exam results are now available', 'Check your performance below')" 
                                        class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                    âœ… Results Ready
                                </button>
                                <button onclick="setQuickMessage('Term examination completed', 'Results will be available soon')" 
                                        class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                    ğŸ“ Exam Complete
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <button id="updateMessageBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ’¾ Update Student Message
                                </button>
                                <div id="updateMessageNotification" class="message mt-2 text-center font-bold"></div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-green-700 font-semibold">Currently Active: <span id="currentActiveTerm" class="text-green-800 font-bold">None</span></p>
                            <div id="setActiveTermNotification" class="mt-2 text-center font-bold"></div>
                        </div>
                    </div>

                    <!-- Admin Controls -->
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-blue-700 font-bold mb-2">ğŸ“… Select Term:</label>
                            <select id="adminTermSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none">
                                <option value="">Choose Term</option>
                                <option value="term1">Term 1</option>
                                <option value="term2">Term 2</option>
                                <option value="term3">Term 3</option>
                                <option value="combined">ğŸŒŸ All Terms Combined</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-blue-700 font-bold mb-2">ğŸ“ Select Class:</label>
                            <select id="adminClassSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none">
                                <option value="">Choose Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-4 shadow-lg">
                            <label class="block text-blue-700 font-bold mb-2">ğŸ‘¦ Select Student:</label>
                            <select id="adminStudentSelect" class="w-full p-3 border-2 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none" disabled>
                                <option value="">Choose Student</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid md:grid-cols-6 gap-4 mb-6">
                        <button id="addStudentBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            â• Add Student
                        </button>
                        <button id="updateMarksBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            âœï¸ Update Marks
                        </button>
                        <button id="viewStudentsBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ‘€ View Students
                        </button>
                        <button id="deleteStudentBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ—‘ï¸ Delete Student
                        </button>
                        <button id="addTermBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ“… Add Term
                        </button>
                        <button id="downloadExcelBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ“Š Download Excel
                        </button>
                        <button id="manageSubjectsBtn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ“‹ Manage Subjects
                        </button>
                    </div>

                    <!-- Messages -->
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div id="addMessage" class="message text-center font-bold"></div>
                        <div id="viewMessage" class="message text-center font-bold"></div>
                        <div id="deleteMessage" class="message text-center font-bold"></div>
                    </div>
                    
                    <!-- Global Success Message -->
                    <div id="globalMessage" class="message text-center font-bold text-lg mb-6"></div>
                </div>

                <!-- Add Student Form -->
                <div id="addStudentForm" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-green-700 text-center mb-6">â• Add New Student</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <input type="text" id="newStudentName" placeholder="Student Name" class="p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none">
                        <input type="text" id="newFatherName" placeholder="Father's Name" class="p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none">
                    </div>
                    <div class="text-center mt-4">
                        <button id="saveStudentBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            ğŸ’¾ Save Student
                        </button>
                    </div>
                </div>

                <!-- Add/Edit Term Form -->
                <div id="addTermForm" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-green-700 text-center mb-6">ğŸ“… Complete Term Management System</h3>
                    
                    <!-- Add New Term Section -->
                    <div class="mb-8 bg-green-50 rounded-2xl p-6 border-2 border-green-200">
                        <h4 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                            â• Add New Term
                            <span class="ml-2 text-sm bg-green-200 px-2 py-1 rounded-full">Create Custom Terms</span>
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-green-700 font-semibold mb-2">ğŸ“ Term Display Name:</label>
                                <input type="text" id="newTermName" placeholder="e.g., Half Yearly Exam, Annual Exam, Unit Test 1, Monthly Test" 
                                       class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none text-lg">
                                <p class="text-sm text-green-600 mt-1">ğŸ’¡ Examples: "Half Yearly Exam", "Annual Exam", "Unit Test 1", "Monthly Assessment", "Pre-Board Exam"</p>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <button onclick="quickAddTerm('Half Yearly Exam')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ“š Half Yearly
                                </button>
                                <button onclick="quickAddTerm('Annual Exam')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ“ Annual Exam
                                </button>
                                <button onclick="quickAddTerm('Unit Test')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ“ Unit Test
                                </button>
                            </div>
                            <div class="text-center">
                                <button id="saveTermBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ’¾ Create New Term
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Existing Terms Section -->
                    <div class="bg-purple-50 rounded-2xl p-6 border-2 border-purple-200">
                        <h4 class="text-xl font-bold text-purple-700 mb-4 flex items-center">
                            âœï¸ Edit & Manage Existing Terms
                            <span class="ml-2 text-sm bg-purple-200 px-2 py-1 rounded-full">Modify or Delete</span>
                        </h4>
                        <div id="existingTermsList" class="space-y-4">
                            <!-- Existing terms will be populated here -->
                        </div>
                        <div class="text-center mt-6">
                            <button id="refreshTermsBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                ğŸ”„ Refresh Terms List
                            </button>
                        </div>
                    </div>
                    
                    <!-- Term Management Tips -->
                    <div class="mt-6 bg-yellow-50 rounded-2xl p-4 border-2 border-yellow-200">
                        <h5 class="text-lg font-bold text-yellow-700 mb-2">ğŸ’¡ Term & Maximum Marks Management Tips:</h5>
                        <ul class="text-yellow-800 space-y-1 text-sm">
                            <li>â€¢ Use descriptive names like "Half Yearly Exam" instead of just "Term 1"</li>
                            <li>â€¢ You can create terms for different types of assessments (Unit Tests, Monthly Tests, etc.)</li>
                            <li>â€¢ <strong>NEW:</strong> Set different maximum marks for each class per term (Class 1 may have 20 max, Class 5 may have 100 max)</li>
                            <li>â€¢ Maximum marks can be configured per class - select a class to set specific oral/written marks</li>
                            <li>â€¢ Use "Default (All Classes)" to set the same maximum marks for all classes</li>
                            <li>â€¢ Editing a term name will update it everywhere in the system</li>
                            <li>â€¢ Deleting a term will permanently remove all marks data for that term</li>
                            <li>â€¢ Terms are shared across all classes, but maximum marks can be class-specific</li>
                        </ul>
                    </div>
                </div>

                <!-- Student Marks Table -->
                <div id="studentMarksTable" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-orange-700 text-center mb-6">ğŸ“Š Student Marks</h3>
                    <div id="marksTableContainer" class="overflow-x-auto"></div>
                    <div class="text-center mt-4 space-x-4">
                        <button id="addSubjectBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                            â• Add Subject
                        </button>
                        <div class="inline-block">
                            <button id="saveAllMarksBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                ğŸ’¾ Save All Marks
                            </button>
                            <div id="saveMarksNotification" class="message mt-2 text-center font-bold"></div>
                        </div>
                    </div>
                </div>

                <!-- Add Subject Form -->
                <div id="addSubjectForm" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-green-700 text-center mb-6">â• Add New Subject</h3>
                    <div class="max-w-md mx-auto">
                        <input type="text" id="newSubjectName" placeholder="Subject Name (e.g., COMPUTER)" class="w-full p-3 border-2 border-green-300 rounded-xl focus:border-green-500 focus:outline-none mb-4">
                        <div class="text-center">
                            <button id="saveSubjectBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                ğŸ’¾ Save Subject
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Manage Subjects Form -->
                <div id="manageSubjectsForm" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-amber-700 text-center mb-6">ğŸ“‹ Manage Subjects & Display Order</h3>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Current Subjects List -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-6 border-2 border-blue-200">
                            <h4 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
                                ğŸ“š Current Subjects Order
                                <span class="ml-2 text-sm bg-blue-200 px-2 py-1 rounded-full">Drag to Reorder</span>
                            </h4>
                            <div id="subjectsList" class="space-y-3">
                                <!-- Subjects will be populated here -->
                            </div>
                            <div class="text-center mt-6 space-x-3">
                                <button id="saveSubjectOrderBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ’¾ Save Order
                                </button>
                                <button id="resetSubjectOrderBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-all duration-300">
                                    ğŸ”„ Reset to Default
                                </button>
                            </div>
                        </div>
                        
                        <!-- Subject Management Actions -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl p-6 border-2 border-green-200">
                            <h4 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                                âš™ï¸ Subject Actions
                                <span class="ml-2 text-sm bg-green-200 px-2 py-1 rounded-full">Add/Remove</span>
                            </h4>
                            
                            <!-- Add New Subject -->
                            <div class="mb-6 p-4 bg-white rounded-xl border-2 border-dashed border-green-300">
                                <h5 class="text-lg font-bold text-green-600 mb-3">â• Add New Subject</h5>
                                <div class="space-y-3">
                                    <input type="text" id="quickAddSubjectName" placeholder="Subject Name (e.g., COMPUTER, ART)" 
                                           class="w-full p-3 border-2 border-green-300 rounded-lg focus:border-green-500 focus:outline-none">
                                    <button id="quickAddSubjectBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300">
                                        â• Add Subject
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Add Presets -->
                            <div class="mb-6 p-4 bg-white rounded-xl border-2 border-dashed border-blue-300">
                                <h5 class="text-lg font-bold text-blue-600 mb-3">ğŸš€ Quick Add Common Subjects</h5>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="quickAddSubject('COMPUTER')" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        ğŸ’» COMPUTER
                                    </button>
                                    <button onclick="quickAddSubject('ART')" class="bg-pink-100 hover:bg-pink-200 text-pink-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        ğŸ¨ ART
                                    </button>
                                    <button onclick="quickAddSubject('MUSIC')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        ğŸµ MUSIC
                                    </button>
                                    <button onclick="quickAddSubject('PE')" class="bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        âš½ PE
                                    </button>
                                    <button onclick="quickAddSubject('SCIENCE')" class="bg-teal-100 hover:bg-teal-200 text-teal-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        ğŸ”¬ SCIENCE
                                    </button>
                                    <button onclick="quickAddSubject('SOCIAL')" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                                        ğŸŒ SOCIAL
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Subject Management Tips -->
                            <div class="p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200">
                                <h5 class="text-sm font-bold text-yellow-700 mb-2">ğŸ’¡ Subject Management Tips:</h5>
                                <ul class="text-yellow-800 space-y-1 text-xs">
                                    <li>â€¢ Drag subjects up/down to change display order</li>
                                    <li>â€¢ Order affects report cards and Excel exports</li>
                                    <li>â€¢ Use ALL CAPS for consistency (e.g., HINDI, ENGLISH)</li>
                                    <li>â€¢ Removing subjects will delete all related marks data</li>
                                    <li>â€¢ Default order: HINDI â†’ ENGLISH â†’ MATHS â†’ EVS â†’ SANSKRIT</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students List -->
                <div id="studentsList" class="hidden bg-white rounded-3xl shadow-2xl p-8 mb-8">
                    <h3 class="text-2xl font-bold text-purple-700 text-center mb-6">ğŸ‘¥ Students List</h3>
                    <div id="studentsTable" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Subject order for consistent display
        const subjectOrder = ['HINDI', 'ENGLISH', 'MATHS', 'EVS', 'SANSKRIT'];
        
        // Default maximum marks for different terms
        const defaultMaxMarks = {
            term1: { oral: 10, written: 10, total: 20 },
            term2: { oral: 50, written: 50, total: 100 },
            term3: { oral: 10, written: 10, total: 20 }
        };

        // Motivational quotes based on performance
        const motivationalQuotes = {
            excellent: [
                "ğŸŒŸ Outstanding performance! You're a shining star! Keep reaching for the sky!",
                "ğŸ† Excellent work! Your dedication and hard work are truly inspiring!",
                "âœ¨ Brilliant achievement! You've set a wonderful example for others!",
                "ğŸ¯ Perfect! Your commitment to excellence shows in every subject!",
                "ğŸŒˆ Exceptional performance! You make learning look effortless!"
            ],
            good: [
                "ğŸ‘ Great job! You're doing wonderfully and making steady progress!",
                "ğŸŒ± Good work! Keep growing and learning with the same enthusiasm!",
                "ğŸ“ˆ Well done! Your efforts are paying off beautifully!",
                "ğŸ’ª Nice progress! You're building strong foundations for success!",
                "ğŸ¨ Good performance! Your potential is shining through!"
            ],
            average: [
                "ğŸŒŸ You're on the right track! Keep pushing forward with confidence!",
                "ğŸ’« Good effort! Every step forward is progress worth celebrating!",
                "ğŸš€ You have great potential! Keep working hard and believe in yourself!",
                "ğŸŒ» Nice work! Remember, every expert was once a beginner!",
                "â­ Keep going! Your determination will lead you to success!"
            ],
            needsImprovement: [
                "ğŸŒ± Every great journey begins with a single step! You can do this!",
                "ğŸ’ª Don't give up! Your hard work will surely pay off soon!",
                "ğŸŒˆ Believe in yourself! You have the power to improve and succeed!",
                "ğŸ¯ Keep trying! Success comes to those who never stop learning!",
                "âœ¨ You're capable of amazing things! Keep working with determination!"
            ]
        };

        // Global active term controlled by admin
        let activeTermForStudents = '';
        
        // Admin-controlled student message
        let studentTileTitle = 'ğŸ“… Currently Viewing Term';
        let studentCustomMessage = '';
        let studentAdditionalInstructions = '';

        // Mock Firebase Database
        let database = {
            students: {
                1: [
                    { id: 1, name: "Aarav Sharma", fatherName: "Rajesh Sharma" },
                    { id: 2, name: "Priya Singh", fatherName: "Suresh Singh" },
                    { id: 3, name: "Arjun Kumar", fatherName: "Vikash Kumar" }
                ],
                2: [
                    { id: 4, name: "Kavya Gupta", fatherName: "Amit Gupta" },
                    { id: 5, name: "Rohit Verma", fatherName: "Manoj Verma" },
                    { id: 6, name: "Sneha Yadav", fatherName: "Ramesh Yadav" }
                ],
                3: [
                    { id: 7, name: "Ankit Mishra", fatherName: "Santosh Mishra" },
                    { id: 8, name: "Pooja Tiwari", fatherName: "Ashok Tiwari" },
                    { id: 9, name: "Vishal Pandey", fatherName: "Dinesh Pandey" }
                ],
                4: [
                    { id: 10, name: "Riya Agarwal", fatherName: "Sanjay Agarwal" },
                    { id: 11, name: "Karan Joshi", fatherName: "Prakash Joshi" },
                    { id: 12, name: "Nisha Srivastava", fatherName: "Ravi Srivastava" }
                ],
                5: [
                    { id: 13, name: "Deepak Chauhan", fatherName: "Mohan Chauhan" },
                    { id: 14, name: "Sakshi Dubey", fatherName: "Vinod Dubey" },
                    { id: 15, name: "Rahul Tripathi", fatherName: "Sunil Tripathi" }
                ]
            },
            marks: {
                term1: {
                    1: { 
                        HINDI: {oral: 8, written: 9, total: 17, maxOral: 10, maxWritten: 10, maxTotal: 20}, 
                        ENGLISH: {oral: 7, written: 8, total: 15, maxOral: 10, maxWritten: 10, maxTotal: 20}, 
                        MATHS: {oral: 9, written: 9, total: 18, maxOral: 10, maxWritten: 10, maxTotal: 20},
                        EVS: {oral: 8, written: 7, total: 15, maxOral: 10, maxWritten: 10, maxTotal: 20},
                        SANSKRIT: {oral: 9, written: 8, total: 17, maxOral: 10, maxWritten: 10, maxTotal: 20}
                    },
                    2: { 
                        HINDI: {oral: 'A', written: 8, total: 8, maxOral: 10, maxWritten: 10, maxTotal: 20}, 
                        ENGLISH: {oral: 8, written: 'A', total: 8, maxOral: 10, maxWritten: 10, maxTotal: 20}, 
                        MATHS: {oral: 6, written: 7, total: 13, maxOral: 10, maxWritten: 10, maxTotal: 20},
                        EVS: {oral: 'A', written: 'A', total: 'A', maxOral: 10, maxWritten: 10, maxTotal: 20}
                    }
                },
                term2: {
                    1: { 
                        HINDI: {oral: 42, written: 45, total: 87, maxOral: 50, maxWritten: 50, maxTotal: 100}, 
                        ENGLISH: {oral: 38, written: 41, total: 79, maxOral: 50, maxWritten: 50, maxTotal: 100}, 
                        MATHS: {oral: 45, written: 47, total: 92, maxOral: 50, maxWritten: 50, maxTotal: 100}
                    }
                },
                term3: {
                    1: { 
                        HINDI: {oral: 9, written: 8, total: 17, maxOral: 10, maxWritten: 10, maxTotal: 20}, 
                        ENGLISH: {oral: 8, written: 9, total: 17, maxOral: 10, maxWritten: 10, maxTotal: 20}
                    }
                }
            }
        };

        const adminPassword = "admin123";

        // DOM Elements
        const studentBtn = document.getElementById('studentBtn');
        const adminBtn = document.getElementById('adminBtn');
        const studentPortal = document.getElementById('studentPortal');
        const adminPanel = document.getElementById('adminPanel');
        const adminLogin = document.getElementById('adminLogin');
        const adminDashboard = document.getElementById('adminDashboard');

        // Student Portal Elements
        const classSelect = document.getElementById('classSelect');
        const studentSelect = document.getElementById('studentSelect');
        const reportCard = document.getElementById('reportCard');

        // Admin Panel Elements
        const adminPasswordInput = document.getElementById('adminPassword');
        const loginBtn = document.getElementById('loginBtn');
        const adminTermSelect = document.getElementById('adminTermSelect');
        const adminClassSelect = document.getElementById('adminClassSelect');
        const adminStudentSelect = document.getElementById('adminStudentSelect');

        // Navigation
        studentBtn.addEventListener('click', () => {
            studentPortal.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            studentBtn.classList.add('bg-pink-600');
            adminBtn.classList.remove('bg-blue-600');
        });

        adminBtn.addEventListener('click', () => {
            adminPanel.classList.remove('hidden');
            studentPortal.classList.add('hidden');
            adminBtn.classList.add('bg-blue-600');
            studentBtn.classList.remove('bg-pink-600');
        });

        // Student Portal Functions
        classSelect.addEventListener('change', updateStudentSelections);

        function updateStudentSelections() {
            const selectedClass = classSelect.value;
            
            studentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (selectedClass) {
                const students = database.students[selectedClass] || [];
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
                studentSelect.disabled = false;
            } else {
                studentSelect.disabled = true;
            }
        }

        studentSelect.addEventListener('change', () => {
            if (activeTermForStudents && classSelect.value && studentSelect.value) {
                displayReportCard();
            } else if (!activeTermForStudents) {
                alert('No term is currently active for viewing. Please contact your teacher.');
            }
        });

        function getMotivationalQuote(percentage) {
            let category;
            if (percentage >= 90) category = 'excellent';
            else if (percentage >= 75) category = 'good';
            else if (percentage >= 60) category = 'average';
            else category = 'needsImprovement';
            
            const quotes = motivationalQuotes[category];
            return quotes[Math.floor(Math.random() * quotes.length)];
        }

        function getTermDisplayName(termValue) {
            // Try to get from admin dropdown first
            const adminOption = Array.from(document.getElementById('adminTermSelect').options).find(opt => opt.value === termValue);
            if (adminOption) return adminOption.textContent;
            
            // Try to get from student view dropdown
            const studentViewOption = Array.from(document.getElementById('studentViewTermSelect').options).find(opt => opt.value === termValue);
            if (studentViewOption) return studentViewOption.textContent;
            
            // Fallback to uppercase
            return termValue.toUpperCase();
        }

        function displayReportCard() {
            const term = activeTermForStudents;
            const classNum = classSelect.value;
            const studentId = parseInt(studentSelect.value);
            
            const student = database.students[classNum]?.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found!');
                return;
            }
            
            // Handle combined report
            if (term === 'combined') {
                displayCombinedReportCard(student, classNum, studentId);
                return;
            }
            
            const marks = database.marks[term]?.[studentId];
            
            // Check if no marks data exists
            if (!marks || Object.keys(marks).length === 0) {
                displayNoMarksAvailable(student, classNum, term);
                return;
            }

            // Display student info in separate rainbow tiles
            document.getElementById('studentInfo').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border-4 border-gradient-to-r from-pink-400 to-purple-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-image: linear-gradient(45deg, #ec4899, #8b5cf6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¦</div>
                            <p class="text-purple-700 font-bold mb-2 text-lg">Student Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.name}</p>
                        </div>
                    </div>
                    <div class="bg-white border-4 border-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border-image: linear-gradient(45deg, #10b981, #3b82f6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¨</div>
                            <p class="text-blue-700 font-bold mb-2 text-lg">Father's Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.fatherName}</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 text-center">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“ Class ${classNum}</p>
                    </div>
                    <div class="bg-gradient-to-r from-teal-400 to-cyan-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“… ${term.toUpperCase()}</p>
                    </div>
                </div>
            `;

            // Reset table structure for normal marks display
            const tableContainer = document.querySelector('.overflow-x-auto');
            tableContainer.innerHTML = `
                <table class="w-full border-collapse border-2 border-purple-300 rounded-lg overflow-hidden">
                    <thead class="bg-purple-500 text-white">
                        <tr>
                            <th class="border-2 border-purple-300 p-3 text-left">ğŸ“š Subject</th>
                            <th class="border-2 border-purple-300 p-3 text-center">ğŸ“Š Marks Obtained</th>
                            <th class="border-2 border-purple-300 p-3 text-center">ğŸ¯ Maximum Marks</th>
                        </tr>
                    </thead>
                    <tbody id="marksTable">
                    </tbody>
                </table>
            `;
            
            // Display marks table
            const marksTable = document.getElementById('marksTable');
            marksTable.innerHTML = '';
            
            // Show summary and absence info
            document.getElementById('summary').classList.remove('hidden');
            
            let totalObtained = 0;
            let totalMaximum = 0;
            let absenceDetails = [];
            let hasAnyMarks = false;
            
            // First check if there are any subjects with marks
            subjectOrder.forEach(subject => {
                if (marks[subject]) {
                    hasAnyMarks = true;
                }
            });
            
            // Only show subjects that have marks data entered by admin
            const subjectsWithData = subjectOrder.filter(subject => {
                const mark = marks[subject];
                // Subject must exist and have actual marks entered
                if (!mark) return false;
                
                // Check if marks have been actually entered by admin (not just default values)
                const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                     (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                     (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                     mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                
                return hasActualMarks;
            });
            
            subjectsWithData.forEach(subject => {
                const mark = marks[subject];
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-purple-50 transition-colors duration-200';
                
                // Check for partial absence and add hash markers
                let displayTotal = mark.total;
                let hashMarker = '';
                
                if (mark.oral === 'A' && mark.written !== 'A') {
                    hashMarker = ' #'; // Hash for oral absent
                    displayTotal = mark.total;
                } else if (mark.written === 'A' && mark.oral !== 'A') {
                    hashMarker = ' #'; // Hash for written absent
                    displayTotal = mark.total;
                } else if (mark.total === 'A') {
                    displayTotal = 'Absent';
                }
                
                const totalClass = mark.total === 'A' ? 'text-red-600' : 'text-purple-600';
                
                // Ensure maxTotal has a valid value for display
                const displayMaxTotal = mark.maxTotal || defaultMaxMarks[term]?.total || 20;
                
                // Calculate star rating based on percentage for this subject
                let starRating = '';
                if (mark.total !== 'A' && displayMaxTotal > 0) {
                    const subjectPercentage = ((mark.total || 0) / displayMaxTotal) * 100;
                    if (subjectPercentage >= 95) {
                        starRating = ' â­â­'; // 2 stars for 95%+
                    } else if (subjectPercentage >= 90) {
                        starRating = ' â­'; // 1 star for 90%+
                    }
                }
                
                row.innerHTML = `
                    <td class="border-2 border-purple-300 p-3 font-semibold">${subject}</td>
                    <td class="border-2 border-purple-300 p-3 text-center font-bold ${totalClass}">${displayTotal}${hashMarker}${starRating}</td>
                    <td class="border-2 border-purple-300 p-3 text-center font-bold text-gray-600">${displayMaxTotal}</td>
                `;
                marksTable.appendChild(row);
                
                // Track absence details for all subjects being displayed
                if (mark.oral === 'A' && mark.written !== 'A') {
                    absenceDetails.push(`${subject} (Oral)`);
                } else if (mark.written === 'A' && mark.oral !== 'A') {
                    absenceDetails.push(`${subject} (Written)`);
                } else if (mark.total === 'A') {
                    absenceDetails.push(`${subject} (Complete)`);
                }
                
                if (mark.total !== 'A') {
                    totalObtained += mark.total || 0;
                }
                // Ensure maxTotal has a valid value, use defaults if undefined
                const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.total || 20;
                if (maxTotal && !isNaN(maxTotal)) {
                    totalMaximum += maxTotal;
                }
            });

            // Add totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'bg-purple-100 font-bold border-t-4 border-purple-500';
            totalsRow.innerHTML = `
                <td class="border-2 border-purple-300 p-3 font-bold text-purple-700">ğŸ“Š TOTAL</td>
                <td class="border-2 border-purple-300 p-3 text-center font-bold text-purple-700">${totalObtained}</td>
                <td class="border-2 border-purple-300 p-3 text-center font-bold text-purple-700">${totalMaximum}</td>
            `;
            marksTable.appendChild(totalsRow);

            // Calculate percentage and rank
            const percentage = totalMaximum > 0 ? ((totalObtained / totalMaximum) * 100).toFixed(2) : 0;
            const rank = calculateRank(studentId, classNum, term);
            
            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('rank').textContent = `#${rank}`;
            
            // Display absence information
            const absenceInfo = document.getElementById('absenceInfo');
            if (absenceDetails.length > 0) {
                absenceInfo.innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-r-lg">
                        <h4 class="text-lg font-bold text-yellow-700 mb-2">âš ï¸ Absence Information:</h4>
                        <p class="text-yellow-800">
                            <strong># Hash Mark indicates:</strong> Student was absent in: ${absenceDetails.join(', ')}
                        </p>
                        <p class="text-blue-800 mt-2">
                            <strong>â­ Star Ratings:</strong> â­â­ = 95%+ marks, â­ = 90%+ marks in subject
                        </p>
                    </div>
                `;
                absenceInfo.classList.remove('hidden');
            } else {
                // Show star rating information even when no absences
                absenceInfo.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h4 class="text-lg font-bold text-blue-700 mb-2">â­ Star Rating System:</h4>
                        <p class="text-blue-800">
                            <strong>â­â­ Two Stars:</strong> 95% or above marks in subject<br>
                            <strong>â­ One Star:</strong> 90% or above marks in subject
                        </p>
                    </div>
                `;
                absenceInfo.classList.remove('hidden');
            }
            
            // Display motivational quote
            const motivationalQuote = document.getElementById('motivationalQuote');
            const quote = getMotivationalQuote(parseFloat(percentage));
            let quoteClass = '';
            let bgColor = '';
            
            if (percentage >= 90) {
                bgColor = 'bg-gradient-to-r from-yellow-200 to-yellow-300';
                quoteClass = 'quote-glow';
            } else if (percentage >= 75) {
                bgColor = 'bg-gradient-to-r from-green-200 to-green-300';
            } else if (percentage >= 60) {
                bgColor = 'bg-gradient-to-r from-blue-200 to-blue-300';
            } else {
                bgColor = 'bg-gradient-to-r from-orange-200 to-orange-300';
            }
            
            motivationalQuote.innerHTML = `
                <div class="${bgColor} ${quoteClass} rounded-2xl p-6 text-center shadow-lg border-2 border-dashed border-gray-400">
                    <h4 class="text-lg font-bold text-gray-700 mb-2">ğŸ’ Message for You</h4>
                    <p class="text-xl font-semibold text-gray-800 italic">${quote}</p>
                </div>
            `;
            
            // Show appropriate celebration based on percentage
            if (percentage >= 85) {
                showTrophyCelebration(parseFloat(percentage), student.name);
            } else if (percentage > 75) {
                showCelebration();
            }
            
            reportCard.classList.remove('hidden');
            reportCard.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateRank(studentId, classNum, term) {
            const classStudents = database.students[classNum] || [];
            const termMarks = database.marks[term] || {};
            
            const percentages = classStudents.map(student => {
                const marks = termMarks[student.id];
                if (!marks) return { id: student.id, percentage: 0 };
                
                let totalObtained = 0;
                let totalMaximum = 0;
                
                // Only calculate for subjects that have actual marks entered by admin
                const subjectsWithData = subjectOrder.filter(subject => {
                    const mark = marks[subject];
                    if (!mark) return false;
                    
                    // Check if marks have been actually entered by admin (not just default values)
                    const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                         (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                         (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                         mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                    
                    return hasActualMarks;
                });
                
                subjectsWithData.forEach(subject => {
                    const mark = marks[subject];
                    if (mark && mark.total !== 'A') {
                        totalObtained += mark.total || 0;
                    }
                    // Use default max marks if maxTotal is undefined
                    const maxTotal = mark?.maxTotal || defaultMaxMarks[term]?.total || 20;
                    if (maxTotal && !isNaN(maxTotal)) {
                        totalMaximum += maxTotal;
                    }
                });
                
                return {
                    id: student.id,
                    percentage: totalMaximum > 0 ? (totalObtained / totalMaximum) * 100 : 0
                };
            });
            
            percentages.sort((a, b) => b.percentage - a.percentage);
            return percentages.findIndex(p => p.id === studentId) + 1;
        }

        function displayCombinedReportCard(student, classNum, studentId) {
            // Display student info in separate rainbow tiles
            document.getElementById('studentInfo').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border-4 border-gradient-to-r from-pink-400 to-purple-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-image: linear-gradient(45deg, #ec4899, #8b5cf6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¦</div>
                            <p class="text-purple-700 font-bold mb-2 text-lg">Student Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.name}</p>
                        </div>
                    </div>
                    <div class="bg-white border-4 border-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border-image: linear-gradient(45deg, #10b981, #3b82f6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¨</div>
                            <p class="text-blue-700 font-bold mb-2 text-lg">Father's Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.fatherName}</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 text-center">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“ Class ${classNum}</p>
                    </div>
                    <div class="bg-gradient-to-r from-teal-400 to-cyan-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“Š ALL TERMS COMBINED</p>
                    </div>
                </div>
            `;

            // Get all available terms with data for this student
            const availableTerms = Object.keys(database.marks).filter(term => {
                const termMarks = database.marks[term][studentId];
                if (!termMarks) return false;
                
                // Check if any subject has actual marks entered
                return subjectOrder.some(subject => {
                    const mark = termMarks[subject];
                    if (!mark) return false;
                    
                    const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                         (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                         (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                         mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                    
                    return hasActualMarks;
                });
            });

            if (availableTerms.length === 0) {
                displayNoMarksAvailable(student, classNum, 'combined');
                return;
            }

            // Create combined table structure
            const tableContainer = document.querySelector('.overflow-x-auto');
            
            // Build headers dynamically based on available terms
            let headerRow = '<th class="border-2 border-purple-300 p-3 text-left">ğŸ“š Subject</th>';
            availableTerms.forEach(term => {
                const termDisplayName = getTermDisplayName(term);
                headerRow += `<th class="border-2 border-purple-300 p-3 text-center" colspan="3">${termDisplayName}</th>`;
            });
            headerRow += '<th class="border-2 border-purple-300 p-3 text-center">ğŸ“Š Total Obtained</th>';
            headerRow += '<th class="border-2 border-purple-300 p-3 text-center">ğŸ¯ Total Maximum</th>';
            headerRow += '<th class="border-2 border-purple-300 p-3 text-center">ğŸ“ˆ Average %</th>';

            // Create sub-headers for oral, written, total
            let subHeaderRow = '<th class="border-2 border-purple-300 p-2 text-left bg-purple-400"></th>';
            availableTerms.forEach(term => {
                subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400">ğŸ—£ï¸ O</th>';
                subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400">âœï¸ W</th>';
                subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400">ğŸ“Š T</th>';
            });
            subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400"></th>';
            subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400"></th>';
            subHeaderRow += '<th class="border-2 border-purple-300 p-2 text-center text-xs bg-purple-400"></th>';

            tableContainer.innerHTML = `
                <table class="w-full border-collapse border-2 border-purple-300 rounded-lg overflow-hidden">
                    <thead class="bg-purple-500 text-white">
                        <tr>${headerRow}</tr>
                        <tr>${subHeaderRow}</tr>
                    </thead>
                    <tbody id="marksTable">
                    </tbody>
                </table>
            `;
            
            const marksTable = document.getElementById('marksTable');
            marksTable.innerHTML = '';
            
            let grandTotalObtained = 0;
            let grandTotalMaximum = 0;
            let allSubjectsData = {};

            // Process each subject across all terms
            subjectOrder.forEach(subject => {
                let subjectHasData = false;
                let subjectTotalObtained = 0;
                let subjectTotalMaximum = 0;
                let termMarksForSubject = [];

                availableTerms.forEach(term => {
                    const termMarks = database.marks[term][studentId];
                    const mark = termMarks?.[subject];
                    
                    if (mark) {
                        const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                             (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                             (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                             mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                        
                        if (hasActualMarks) {
                            subjectHasData = true;
                            
                            let displayOral = mark.oral === 'A' ? 'A' : (mark.oral || 0);
                            let displayWritten = mark.written === 'A' ? 'A' : (mark.written || 0);
                            let displayTotal = mark.total;
                            let hashMarker = '';
                            
                            if (mark.oral === 'A' && mark.written !== 'A') {
                                hashMarker = ' #';
                            } else if (mark.written === 'A' && mark.oral !== 'A') {
                                hashMarker = ' #';
                            } else if (mark.total === 'A') {
                                displayTotal = 'A';
                            }
                            
                            // Calculate star rating
                            let starRating = '';
                            const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.[classNum]?.total || defaultMaxMarks[term]?.default?.total || 20;
                            if (mark.total !== 'A' && maxTotal > 0) {
                                const subjectPercentage = ((mark.total || 0) / maxTotal) * 100;
                                if (subjectPercentage >= 95) {
                                    starRating = ' â­â­';
                                } else if (subjectPercentage >= 90) {
                                    starRating = ' â­';
                                }
                            }
                            
                            termMarksForSubject.push({
                                oral: displayOral,
                                written: displayWritten,
                                total: `${displayTotal}${hashMarker}${starRating}`
                            });
                            
                            if (mark.total !== 'A') {
                                subjectTotalObtained += mark.total || 0;
                            }
                            subjectTotalMaximum += maxTotal;
                        } else {
                            termMarksForSubject.push({
                                oral: '-',
                                written: '-',
                                total: '-'
                            });
                        }
                    } else {
                        termMarksForSubject.push({
                            oral: '-',
                            written: '-',
                            total: '-'
                        });
                    }
                });

                // Only show subjects that have data in at least one term
                if (subjectHasData) {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-purple-50 transition-colors duration-200';
                    
                    const subjectPercentage = subjectTotalMaximum > 0 ? ((subjectTotalObtained / subjectTotalMaximum) * 100).toFixed(1) : 0;
                    
                    let rowContent = `<td class="border-2 border-purple-300 p-3 font-semibold">${subject}</td>`;
                    
                    // Add term marks (oral, written, total for each term)
                    termMarksForSubject.forEach(termMark => {
                        const oralClass = termMark.oral === 'A' ? 'text-red-600' : 'text-blue-600';
                        const writtenClass = termMark.written === 'A' ? 'text-red-600' : 'text-green-600';
                        const totalClass = termMark.total.includes('A') ? 'text-red-600' : 'text-purple-600';
                        
                        rowContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold ${oralClass} text-sm">${termMark.oral}</td>`;
                        rowContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold ${writtenClass} text-sm">${termMark.written}</td>`;
                        rowContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold text-red-600 text-sm">${termMark.total}</td>`;
                    });
                    
                    // Add totals and percentage
                    rowContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-green-600">${subjectTotalObtained}</td>`;
                    rowContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-gray-600">${subjectTotalMaximum}</td>`;
                    rowContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-blue-600">${subjectPercentage}%</td>`;
                    
                    row.innerHTML = rowContent;
                    marksTable.appendChild(row);
                    
                    grandTotalObtained += subjectTotalObtained;
                    grandTotalMaximum += subjectTotalMaximum;
                    
                    allSubjectsData[subject] = {
                        obtained: subjectTotalObtained,
                        maximum: subjectTotalMaximum,
                        percentage: parseFloat(subjectPercentage)
                    };
                }
            });

            // Add grand totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'bg-purple-100 font-bold border-t-4 border-purple-500';
            
            let totalsContent = `<td class="border-2 border-purple-300 p-3 font-bold text-purple-700">ğŸ“Š GRAND TOTAL</td>`;
            
            // Add term totals (oral, written, total for each term)
            availableTerms.forEach(term => {
                let termOralTotal = 0;
                let termWrittenTotal = 0;
                let termTotal = 0;
                const termMarks = database.marks[term][studentId] || {};
                
                subjectOrder.forEach(subject => {
                    const mark = termMarks[subject];
                    if (mark) {
                        const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                             (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                             (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                             mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                        
                        if (hasActualMarks) {
                            if (mark.oral !== 'A') termOralTotal += mark.oral || 0;
                            if (mark.written !== 'A') termWrittenTotal += mark.written || 0;
                            if (mark.total !== 'A') termTotal += mark.total || 0;
                        }
                    }
                });
                
                totalsContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold text-blue-700 text-sm">${termOralTotal}</td>`;
                totalsContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold text-green-700 text-sm">${termWrittenTotal}</td>`;
                totalsContent += `<td class="border-2 border-purple-300 p-2 text-center font-bold text-red-600 text-sm">${termTotal}</td>`;
            });
            
            const grandPercentage = grandTotalMaximum > 0 ? ((grandTotalObtained / grandTotalMaximum) * 100).toFixed(2) : 0;
            
            totalsContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-purple-700">${grandTotalObtained}</td>`;
            totalsContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-purple-700">${grandTotalMaximum}</td>`;
            totalsContent += `<td class="border-2 border-purple-300 p-3 text-center font-bold text-purple-700">${grandPercentage}%</td>`;
            
            totalsRow.innerHTML = totalsContent;
            marksTable.appendChild(totalsRow);

            // Calculate combined rank
            const combinedRank = calculateCombinedRank(studentId, classNum);
            
            // Update summary section
            document.getElementById('percentage').textContent = `${grandPercentage}%`;
            document.getElementById('rank').textContent = `#${combinedRank}`;
            document.getElementById('summary').classList.remove('hidden');
            
            // Show term-wise performance breakdown
            const absenceInfo = document.getElementById('absenceInfo');
            let termBreakdown = `
                <div class="bg-gradient-to-r from-blue-100 to-indigo-100 border-l-4 border-blue-500 p-6 rounded-r-lg">
                    <h4 class="text-xl font-bold text-blue-700 mb-4">ğŸ“Š Term-wise Performance Breakdown:</h4>
                    <div class="grid md:grid-cols-${Math.min(availableTerms.length, 3)} gap-4 mb-4">
            `;
            
            availableTerms.forEach(term => {
                const termMarks = database.marks[term][studentId] || {};
                let termObtained = 0;
                let termMaximum = 0;
                
                subjectOrder.forEach(subject => {
                    const mark = termMarks[subject];
                    if (mark) {
                        const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                             (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                             (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                             mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                        
                        if (hasActualMarks) {
                            if (mark.total !== 'A') {
                                termObtained += mark.total || 0;
                            }
                            const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.[classNum]?.total || defaultMaxMarks[term]?.default?.total || 20;
                            termMaximum += maxTotal;
                        }
                    }
                });
                
                const termPercentage = termMaximum > 0 ? ((termObtained / termMaximum) * 100).toFixed(1) : 0;
                const termDisplayName = getTermDisplayName(term);
                
                let performanceColor = 'bg-red-200 text-red-800';
                if (termPercentage >= 90) performanceColor = 'bg-green-200 text-green-800';
                else if (termPercentage >= 75) performanceColor = 'bg-blue-200 text-blue-800';
                else if (termPercentage >= 60) performanceColor = 'bg-yellow-200 text-yellow-800';
                
                termBreakdown += `
                    <div class="${performanceColor} rounded-lg p-4 text-center">
                        <h5 class="font-bold text-sm mb-2">${termDisplayName}</h5>
                        <p class="text-lg font-bold">${termPercentage}%</p>
                        <p class="text-xs">${termObtained}/${termMaximum}</p>
                    </div>
                `;
            });
            
            termBreakdown += `
                    </div>
                    <div class="bg-white rounded-lg p-4 border-2 border-dashed border-blue-300">
                        <p class="text-blue-800 text-sm">
                            <strong>â­ Star Ratings:</strong> â­â­ = 95%+ marks, â­ = 90%+ marks in subject<br>
                            <strong># Hash Mark:</strong> Indicates partial absence in that term<br>
                            <strong>ğŸ“ˆ Combined Performance:</strong> Shows overall progress across all terms
                        </p>
                    </div>
                </div>
            `;
            
            absenceInfo.innerHTML = termBreakdown;
            absenceInfo.classList.remove('hidden');
            
            // Display motivational quote based on combined performance
            const motivationalQuote = document.getElementById('motivationalQuote');
            const quote = getMotivationalQuote(parseFloat(grandPercentage));
            let quoteClass = '';
            let bgColor = '';
            
            if (grandPercentage >= 90) {
                bgColor = 'bg-gradient-to-r from-yellow-200 to-yellow-300';
                quoteClass = 'quote-glow';
            } else if (grandPercentage >= 75) {
                bgColor = 'bg-gradient-to-r from-green-200 to-green-300';
            } else if (grandPercentage >= 60) {
                bgColor = 'bg-gradient-to-r from-blue-200 to-blue-300';
            } else {
                bgColor = 'bg-gradient-to-r from-orange-200 to-orange-300';
            }
            
            motivationalQuote.innerHTML = `
                <div class="${bgColor} ${quoteClass} rounded-2xl p-6 text-center shadow-lg border-2 border-dashed border-gray-400">
                    <h4 class="text-lg font-bold text-gray-700 mb-2">ğŸ’ Combined Performance Message</h4>
                    <p class="text-xl font-semibold text-gray-800 italic">${quote}</p>
                    <p class="text-sm text-gray-600 mt-2">Based on performance across ${availableTerms.length} term(s)</p>
                </div>
            `;
            
            // Show appropriate celebration based on combined percentage
            if (grandPercentage >= 85) {
                showTrophyCelebration(parseFloat(grandPercentage), student.name);
            } else if (grandPercentage > 75) {
                showCelebration();
            }
            
            reportCard.classList.remove('hidden');
            reportCard.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateCombinedRank(studentId, classNum) {
            const classStudents = database.students[classNum] || [];
            
            const combinedPercentages = classStudents.map(student => {
                let totalObtained = 0;
                let totalMaximum = 0;
                
                // Calculate across all terms
                Object.keys(database.marks).forEach(term => {
                    const termMarks = database.marks[term][student.id] || {};
                    
                    subjectOrder.forEach(subject => {
                        const mark = termMarks[subject];
                        if (mark) {
                            const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                                 (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                                 (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                                 mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                            
                            if (hasActualMarks) {
                                if (mark.total !== 'A') {
                                    totalObtained += mark.total || 0;
                                }
                                const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.[classNum]?.total || defaultMaxMarks[term]?.default?.total || 20;
                                totalMaximum += maxTotal;
                            }
                        }
                    });
                });
                
                return {
                    id: student.id,
                    percentage: totalMaximum > 0 ? (totalObtained / totalMaximum) * 100 : 0
                };
            });
            
            combinedPercentages.sort((a, b) => b.percentage - a.percentage);
            return combinedPercentages.findIndex(p => p.id === studentId) + 1;
        }

        function displayNoMarksAvailable(student, classNum, term) {
            // Display student info in separate rainbow tiles
            document.getElementById('studentInfo').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border-4 border-gradient-to-r from-pink-400 to-purple-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-image: linear-gradient(45deg, #ec4899, #8b5cf6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¦</div>
                            <p class="text-purple-700 font-bold mb-2 text-lg">Student Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.name}</p>
                        </div>
                    </div>
                    <div class="bg-white border-4 border-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-6 shadow-xl transform hover:scale-105 transition-all duration-300" style="background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border-image: linear-gradient(45deg, #10b981, #3b82f6) 1;">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ‘¨</div>
                            <p class="text-blue-700 font-bold mb-2 text-lg">Father's Name</p>
                            <p class="text-2xl font-bold bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${student.fatherName}</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 text-center">
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“ Class ${classNum}</p>
                    </div>
                    <div class="bg-gradient-to-r from-teal-400 to-cyan-500 rounded-xl p-4 shadow-md">
                        <p class="text-xl font-bold text-white">ğŸ“… ${term.toUpperCase()}</p>
                    </div>
                </div>
            `;

            // Reset table structure for normal display
            const tableContainer = document.querySelector('.overflow-x-auto');
            tableContainer.innerHTML = `
                <table class="w-full border-collapse border-2 border-purple-300 rounded-lg overflow-hidden">
                    <thead class="bg-purple-500 text-white">
                        <tr>
                            <th class="border-2 border-purple-300 p-3 text-left">ğŸ“š Subject</th>
                            <th class="border-2 border-purple-300 p-3 text-center">ğŸ“Š Marks Obtained</th>
                            <th class="border-2 border-purple-300 p-3 text-center">ğŸ¯ Maximum Marks</th>
                        </tr>
                    </thead>
                    <tbody id="marksTable">
                        <tr>
                            <td colspan="3" class="border-2 border-purple-300 p-8 text-center">
                                <div class="text-gray-500">
                                    <div class="text-4xl mb-4">ğŸ“‹</div>
                                    <p class="text-xl font-semibold">No marks data available for this term</p>
                                    <p class="text-sm mt-2">Please check back later or contact your teacher</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            // Hide summary and absence info
            document.getElementById('summary').classList.add('hidden');
            document.getElementById('absenceInfo').classList.add('hidden');
            
            // Show motivational message for no data
            const motivationalQuote = document.getElementById('motivationalQuote');
            motivationalQuote.innerHTML = `
                <div class="bg-gradient-to-r from-blue-200 to-indigo-300 rounded-2xl p-6 text-center shadow-lg border-2 border-dashed border-gray-400">
                    <h4 class="text-lg font-bold text-gray-700 mb-2">ğŸ’ Message for You</h4>
                    <p class="text-xl font-semibold text-gray-800 italic">ğŸ“š Keep learning and growing! Your marks will be available once they are entered by your teacher. Stay curious and keep asking questions!</p>
                </div>
            `;
            
            reportCard.classList.remove('hidden');
            reportCard.scrollIntoView({ behavior: 'smooth' });
        }

        function showCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.classList.remove('hidden');
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = ['#f39c12', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6'][Math.floor(Math.random() * 5)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                celebration.appendChild(confetti);
            }
            
            setTimeout(() => {
                celebration.classList.add('hidden');
                celebration.innerHTML = '';
            }, 3000);
        }

        function showTrophyCelebration(percentage, studentName) {
            const trophyCelebration = document.getElementById('trophyCelebration');
            const trophyMessage = document.getElementById('trophyMessage');
            const trophyPercentage = document.getElementById('trophyPercentage');
            const trophySparkles = document.getElementById('trophySparkles');
            
            // Set dynamic message based on percentage
            let message = 'OUTSTANDING PERFORMANCE!';
            if (percentage >= 95) {
                message = 'ğŸ‰ EXCEPTIONAL EXCELLENCE! ğŸ‰';
            } else if (percentage >= 90) {
                message = 'â­ BRILLIANT ACHIEVEMENT! â­';
            } else if (percentage >= 85) {
                message = 'ğŸŒŸ EXCELLENT WORK! ğŸŒŸ';
            }
            
            trophyMessage.textContent = message;
            trophyPercentage.textContent = `${percentage}%`;
            
            // Clear previous sparkles
            trophySparkles.innerHTML = '';
            
            // Create floating sparkles
            const sparkleEmojis = ['âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŠ', 'ğŸ‰', 'ğŸ†', 'ğŸ‘‘'];
            for (let i = 0; i < 30; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.textContent = sparkleEmojis[Math.floor(Math.random() * sparkleEmojis.length)];
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 3 + 's';
                sparkle.style.animationDuration = (2 + Math.random() * 2) + 's';
                trophySparkles.appendChild(sparkle);
            }
            
            // Show trophy celebration
            trophyCelebration.classList.remove('hidden');
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                closeTrophyCelebration();
            }, 8000);
        }

        // Global function for closing trophy celebration
        window.closeTrophyCelebration = function() {
            const trophyCelebration = document.getElementById('trophyCelebration');
            trophyCelebration.classList.add('hidden');
            
            // Clear sparkles
            const trophySparkles = document.getElementById('trophySparkles');
            trophySparkles.innerHTML = '';
        };

        // Admin Panel Functions
        loginBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            const loginMessage = document.getElementById('loginMessage');
            
            if (password === adminPassword) {
                adminLogin.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                showMessage(loginMessage, 'Login Successful! ğŸ‰', 'text-green-500');
            } else {
                showMessage(loginMessage, 'Invalid Password! âŒ', 'text-red-500');
            }
        });

        adminTermSelect.addEventListener('change', updateAdminStudentList);
        adminClassSelect.addEventListener('change', updateAdminStudentList);
        adminStudentSelect.addEventListener('change', () => {
            if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                if (adminTermSelect.value === 'combined') {
                    displayAdminCombinedMarks();
                } else {
                    displayStudentMarks();
                }
            }
        });

        function updateAdminStudentList() {
            const selectedClass = adminClassSelect.value;
            adminStudentSelect.innerHTML = '<option value="">Choose Student</option>';
            
            if (selectedClass) {
                const students = database.students[selectedClass] || [];
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    adminStudentSelect.appendChild(option);
                });
                adminStudentSelect.disabled = false;
            } else {
                adminStudentSelect.disabled = true;
                document.getElementById('studentMarksTable').classList.add('hidden');
            }
        }

        // Admin Action Buttons
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            toggleForm('addStudentForm');
            showMessage(document.getElementById('addMessage'), 'Add Student Form Opened! ğŸ“', 'text-blue-500');
        });

        document.getElementById('updateMarksBtn').addEventListener('click', () => {
            if (!adminTermSelect.value || !adminClassSelect.value || !adminStudentSelect.value) {
                showMessage(document.getElementById('globalMessage'), 'Please select Term, Class and Student! âš ï¸', 'text-orange-500');
                return;
            }
            if (adminTermSelect.value === 'combined') {
                displayAdminCombinedMarks();
                showMessage(document.getElementById('globalMessage'), 'Combined Marks Table Displayed! âœï¸', 'text-blue-500');
            } else {
                displayStudentMarks();
                showMessage(document.getElementById('globalMessage'), 'Marks Table Displayed! âœï¸', 'text-blue-500');
            }
        });

        document.getElementById('addTermBtn').addEventListener('click', () => {
            toggleForm('addTermForm');
            displayExistingTerms();
        });

        document.getElementById('refreshTermsBtn').addEventListener('click', () => {
            displayExistingTerms();
            showMessage(document.getElementById('globalMessage'), 'ğŸ”„ Terms list refreshed!', 'text-blue-500');
        });

        document.getElementById('viewStudentsBtn').addEventListener('click', () => {
            if (!adminClassSelect.value) {
                showMessage(document.getElementById('viewMessage'), 'Please select a Class! âš ï¸', 'text-orange-500');
                return;
            }
            displayStudentsList();
            showMessage(document.getElementById('viewMessage'), 'Students List Displayed! ğŸ‘€', 'text-green-500');
        });

        document.getElementById('deleteStudentBtn').addEventListener('click', () => {
            if (!adminClassSelect.value || !adminStudentSelect.value) {
                showMessage(document.getElementById('deleteMessage'), 'Please select Class and Student! âš ï¸', 'text-orange-500');
                return;
            }
            deleteStudent();
        });

        document.getElementById('addSubjectBtn').addEventListener('click', () => {
            toggleForm('addSubjectForm');
        });

        document.getElementById('downloadExcelBtn').addEventListener('click', () => {
            if (!adminClassSelect.value) {
                showMessage(document.getElementById('globalMessage'), 'Please select Class for Excel download! âš ï¸', 'text-orange-500');
                return;
            }
            downloadExcelReport();
        });

        document.getElementById('manageSubjectsBtn').addEventListener('click', () => {
            toggleForm('manageSubjectsForm');
            displaySubjectsList();
            showMessage(document.getElementById('globalMessage'), 'Subject Management Panel Opened! ğŸ“‹', 'text-amber-500');
        });

        // Set Active Term for Students
        document.getElementById('setActiveTermBtn').addEventListener('click', () => {
            const selectedTerm = document.getElementById('studentViewTermSelect').value;
            const termName = document.getElementById('studentViewTermSelect').selectedOptions[0]?.textContent || 'None';
            
            activeTermForStudents = selectedTerm;
            
            // Update displays
            document.getElementById('currentActiveTerm').textContent = termName;
            document.getElementById('activeTermName').textContent = termName;
            
            // Show success message below the button
            const notificationDiv = document.getElementById('setActiveTermNotification');
            if (selectedTerm) {
                notificationDiv.innerHTML = `
                    <div class="bg-green-100 border-l-4 border-green-500 p-4 rounded-r-lg mt-3">
                        <div class="flex items-center">
                            <div class="text-green-500 text-xl mr-3">ğŸ¯</div>
                            <div>
                                <p class="text-green-700 font-bold">Active Term Set Successfully!</p>
                                <p class="text-green-600 text-sm">Term "${termName}" is now active - Students can view this term's reports</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                notificationDiv.innerHTML = `
                    <div class="bg-orange-100 border-l-4 border-orange-500 p-4 rounded-r-lg mt-3">
                        <div class="flex items-center">
                            <div class="text-orange-500 text-xl mr-3">ğŸš«</div>
                            <div>
                                <p class="text-orange-700 font-bold">No Active Term</p>
                                <p class="text-orange-600 text-sm">Students cannot view any reports until a term is activated</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show the notification with proper timing
            notificationDiv.style.display = 'block';
            notificationDiv.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notificationDiv.classList.remove('show');
                setTimeout(() => {
                    notificationDiv.style.display = 'none';
                }, 300);
            }, 5000);
            
            // Clear student report if they were viewing something
            reportCard.classList.add('hidden');
        });

        // Update Student Message
        document.getElementById('updateMessageBtn').addEventListener('click', () => {
            const newTitle = document.getElementById('customTileTitle').value.trim();
            const newMessage = document.getElementById('customMessage').value.trim();
            const newInstructions = document.getElementById('additionalInstructions').value.trim();
            
            if (!newTitle) {
                alert('Please enter a tile title!');
                document.getElementById('customTileTitle').focus();
                return;
            }
            
            if (!newMessage) {
                alert('Please enter a custom message!');
                document.getElementById('customMessage').focus();
                return;
            }
            
            // Update global variables
            studentTileTitle = newTitle;
            studentCustomMessage = newMessage;
            studentAdditionalInstructions = newInstructions;
            
            // Update student display immediately
            updateStudentMessageDisplay();
            
            showMessage(document.getElementById('updateMessageNotification'), 'âœ… Student message tile updated successfully! Students will see the new message.', 'text-green-500');
        });

        // Save Term
        document.getElementById('saveTermBtn').addEventListener('click', () => {
            const displayName = document.getElementById('newTermName').value.trim();
            
            if (!displayName) {
                showMessage(document.getElementById('globalMessage'), 'âš ï¸ Please enter a term name!', 'text-orange-500');
                document.getElementById('newTermName').focus();
                return;
            }
            
            // Validate term name length
            if (displayName.length < 3) {
                showMessage(document.getElementById('globalMessage'), 'âš ï¸ Term name must be at least 3 characters long!', 'text-orange-500');
                document.getElementById('newTermName').focus();
                return;
            }
            
            if (displayName.length > 50) {
                showMessage(document.getElementById('globalMessage'), 'âš ï¸ Term name must be less than 50 characters!', 'text-orange-500');
                document.getElementById('newTermName').focus();
                return;
            }
            
            // Create unique term ID from display name
            const termName = displayName.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '') // Remove special characters
                .replace(/\s+/g, '') // Remove spaces
                .substring(0, 20); // Limit length
            
            // Check if term already exists (by display name, case insensitive)
            const existingTerms = Array.from(adminTermSelect.options)
                .filter(opt => opt.value !== '')
                .map(opt => opt.textContent.toLowerCase());
            
            if (existingTerms.includes(displayName.toLowerCase())) {
                showMessage(document.getElementById('globalMessage'), `âŒ Term "${displayName}" already exists!`, 'text-red-500');
                document.getElementById('newTermName').focus();
                return;
            }
            
            // Ensure unique term ID
            let uniqueTermName = termName;
            let counter = 1;
            const existingIds = Array.from(adminTermSelect.options).map(opt => opt.value);
            while (existingIds.includes(uniqueTermName)) {
                uniqueTermName = termName + counter;
                counter++;
            }
            
            // Add to admin dropdown
            const adminOption = document.createElement('option');
            adminOption.value = uniqueTermName;
            adminOption.textContent = displayName;
            adminTermSelect.appendChild(adminOption);
            
            // Add to student view control dropdown
            const studentViewOption = document.createElement('option');
            studentViewOption.value = uniqueTermName;
            studentViewOption.textContent = displayName;
            document.getElementById('studentViewTermSelect').appendChild(studentViewOption);
            
            // Initialize database structure for new term
            database.marks[uniqueTermName] = {};
            
            showMessage(document.getElementById('globalMessage'), `âœ… Term "${displayName}" created successfully!`, 'text-green-500');
            document.getElementById('newTermName').value = '';
            
            // Refresh the existing terms list
            displayExistingTerms();
            
            // Show success animation
            const saveBtn = document.getElementById('saveTermBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'ğŸ‰ Created!';
            saveBtn.classList.add('bg-green-600');
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('bg-green-600');
            }, 2000);
        });

        // Save Subject
        document.getElementById('saveSubjectBtn').addEventListener('click', () => {
            const subjectName = document.getElementById('newSubjectName').value.trim().toUpperCase();
            
            if (!subjectName) {
                alert('Please enter a subject name!');
                return;
            }
            
            if (!subjectOrder.includes(subjectName)) {
                subjectOrder.push(subjectName);
                
                // Subject added to the system
                
                alert(`Subject "${subjectName}" added successfully!`);
                document.getElementById('newSubjectName').value = '';
                toggleForm('addSubjectForm');
                
                if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                    displayStudentMarks();
                }
            } else {
                alert('Subject already exists!');
            }
        });

        // Quick Add Subject
        document.getElementById('quickAddSubjectBtn').addEventListener('click', () => {
            const subjectName = document.getElementById('quickAddSubjectName').value.trim().toUpperCase();
            
            if (!subjectName) {
                alert('Please enter a subject name!');
                return;
            }
            
            if (!subjectOrder.includes(subjectName)) {
                subjectOrder.push(subjectName);
                displaySubjectsList();
                showMessage(document.getElementById('globalMessage'), `âœ… Subject "${subjectName}" added successfully!`, 'text-green-500');
                document.getElementById('quickAddSubjectName').value = '';
                
                if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                    displayStudentMarks();
                }
            } else {
                showMessage(document.getElementById('globalMessage'), `âŒ Subject "${subjectName}" already exists!`, 'text-red-500');
            }
        });

        // Save Subject Order
        document.getElementById('saveSubjectOrderBtn').addEventListener('click', () => {
            const subjectItems = document.querySelectorAll('#subjectsList .subject-item');
            const newOrder = Array.from(subjectItems).map(item => item.dataset.subject);
            
            // Update the global subject order
            subjectOrder.length = 0;
            subjectOrder.push(...newOrder);
            
            showMessage(document.getElementById('globalMessage'), 'âœ… Subject order saved successfully!', 'text-green-500');
            
            // Refresh marks table if currently viewing
            if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                displayStudentMarks();
            }
        });

        // Reset Subject Order
        document.getElementById('resetSubjectOrderBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset to default subject order?\n\nDefault: HINDI â†’ ENGLISH â†’ MATHS â†’ EVS â†’ SANSKRIT')) {
                const defaultOrder = ['HINDI', 'ENGLISH', 'MATHS', 'EVS', 'SANSKRIT'];
                
                // Keep existing subjects that are not in default, add them at the end
                const customSubjects = subjectOrder.filter(subject => !defaultOrder.includes(subject));
                
                // Reset to default order plus custom subjects
                subjectOrder.length = 0;
                subjectOrder.push(...defaultOrder, ...customSubjects);
                
                displaySubjectsList();
                showMessage(document.getElementById('globalMessage'), 'ğŸ”„ Subject order reset to default!', 'text-blue-500');
                
                // Refresh marks table if currently viewing
                if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                    displayStudentMarks();
                }
            }
        });

        // Save Student
        document.getElementById('saveStudentBtn').addEventListener('click', () => {
            const name = document.getElementById('newStudentName').value.trim();
            const fatherName = document.getElementById('newFatherName').value.trim();
            const classNum = adminClassSelect.value;
            
            if (!name || !fatherName || !classNum) {
                alert('Please fill all fields and select a class!');
                return;
            }
            
            if (!database.students[classNum]) {
                database.students[classNum] = [];
            }
            
            const existingIds = Object.values(database.students).flat().map(s => s.id);
            const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
            
            database.students[classNum].push({
                id: newId,
                name: name,
                fatherName: fatherName
            });
            
            document.getElementById('newStudentName').value = '';
            document.getElementById('newFatherName').value = '';
            updateAdminStudentList();
            showMessage(document.getElementById('addMessage'), 'Student Added Successfully! âœ…', 'text-green-500');
            toggleForm('addStudentForm');
        });

        // Save All Marks - Fixed Version
        document.getElementById('saveAllMarksBtn').addEventListener('click', () => {
            const term = adminTermSelect.value;
            const classNum = adminClassSelect.value;
            const studentId = parseInt(adminStudentSelect.value);
            
            if (!term || !classNum || !studentId) {
                alert('Please select Term, Class and Student!');
                return;
            }
            
            const student = database.students[classNum]?.find(s => s.id === studentId);
            if (!student) {
                alert('Student not found!');
                return;
            }

            // Handle combined view differently
            if (term === 'combined') {
                saveCombinedMarks(studentId, student.name);
                return;
            }
            
            // Validate all inputs before saving
            const allInputs = document.querySelectorAll('#marksTableContainer input[data-subject]:not([readonly])');
            let validationError = false;
            let errorMessage = '';
            
            allInputs.forEach(input => {
                const subject = input.dataset.subject;
                const field = input.dataset.field;
                const value = input.value.trim();
                
                if (field === 'oral' || field === 'written') {
                    if (value && value.toUpperCase() !== 'A') {
                        const numValue = parseInt(value);
                        const maxField = field === 'oral' ? 'maxOral' : 'maxWritten';
                        const maxInput = document.querySelector(`input[data-subject="${subject}"][data-field="${maxField}"]`);
                        const maxValue = parseInt(maxInput?.value) || 0;
                        
                        if (isNaN(numValue) || numValue < 0) {
                            errorMessage = `âŒ Invalid ${field} marks for ${subject}! Please enter a valid number or 'A' for absent.`;
                            validationError = true;
                            input.classList.add('error-input');
                            return;
                        }
                        
                        if (numValue > maxValue) {
                            errorMessage = `âŒ ${field.charAt(0).toUpperCase() + field.slice(1)} marks (${numValue}) cannot exceed maximum ${field} marks (${maxValue}) for ${subject}!`;
                            validationError = true;
                            input.classList.add('error-input');
                            return;
                        }
                        
                        input.classList.remove('error-input');
                        input.classList.add('success-input');
                    }
                }
            });
            
            if (validationError) {
                alert(errorMessage);
                showMessage(document.getElementById('saveMarksNotification'), errorMessage, 'text-red-500');
                return;
            }
            
            // Initialize database structure if needed
            if (!database.marks[term]) database.marks[term] = {};
            if (!database.marks[term][studentId]) database.marks[term][studentId] = {};
            
            let hasChanges = false;
            
            // Save all marks data
            allInputs.forEach(input => {
                const subject = input.dataset.subject;
                const field = input.dataset.field;
                const value = input.value.trim();
                
                if (!database.marks[term][studentId][subject]) {
                    database.marks[term][studentId][subject] = {};
                }
                
                if (field === 'oral' || field === 'written') {
                    if (value.toUpperCase() === 'A') {
                        database.marks[term][studentId][subject][field] = 'A';
                    } else {
                        database.marks[term][studentId][subject][field] = parseInt(value) || 0;
                    }
                } else {
                    database.marks[term][studentId][subject][field] = parseInt(value) || 0;
                }
                hasChanges = true;
            });
            
            // Calculate and save total marks for each subject
            subjectOrder.forEach(subject => {
                if (database.marks[term][studentId][subject]) {
                    const oral = database.marks[term][studentId][subject].oral;
                    const written = database.marks[term][studentId][subject].written;
                    
                    // Only mark as 'A' if both oral and written are absent
                    if (oral === 'A' && written === 'A') {
                        database.marks[term][studentId][subject].total = 'A';
                    } else {
                        const oralMarks = oral === 'A' ? 0 : (oral || 0);
                        const writtenMarks = written === 'A' ? 0 : (written || 0);
                        database.marks[term][studentId][subject].total = oralMarks + writtenMarks;
                    }
                }
            });
            
            if (hasChanges) {
                showMessage(document.getElementById('saveMarksNotification'), `âœ… All marks saved successfully for ${student.name}!`, 'text-green-500');
                displayStudentMarks(); // Refresh the table
            } else {
                showMessage(document.getElementById('saveMarksNotification'), 'âš ï¸ No changes to save!', 'text-orange-500');
            }
        });

        function saveCombinedMarks(studentId, studentName) {
            // Get all inputs from combined view
            const allInputs = document.querySelectorAll('#combinedMarksTableBody input[data-subject][data-term]:not([readonly])');
            let validationError = false;
            let errorMessage = '';
            let hasChanges = false;
            
            // Validate all inputs before saving
            allInputs.forEach(input => {
                const subject = input.dataset.subject;
                const field = input.dataset.field;
                const term = input.dataset.term;
                const value = input.value.trim();
                
                if (field === 'oral' || field === 'written') {
                    if (value && value.toUpperCase() !== 'A') {
                        const numValue = parseInt(value);
                        const maxValue = defaultMaxMarks[term]?.[field] || (field === 'oral' ? 10 : 10);
                        
                        if (isNaN(numValue) || numValue < 0) {
                            errorMessage = `âŒ Invalid ${field} marks for ${subject} in ${term}! Please enter a valid number or 'A' for absent.`;
                            validationError = true;
                            input.classList.add('error-input');
                            return;
                        }
                        
                        if (numValue > maxValue) {
                            errorMessage = `âŒ ${field.charAt(0).toUpperCase() + field.slice(1)} marks (${numValue}) cannot exceed maximum ${field} marks (${maxValue}) for ${subject} in ${term}!`;
                            validationError = true;
                            input.classList.add('error-input');
                            return;
                        }
                        
                        input.classList.remove('error-input');
                        input.classList.add('success-input');
                    }
                }
            });
            
            if (validationError) {
                alert(errorMessage);
                showMessage(document.getElementById('saveMarksNotification'), errorMessage, 'text-red-500');
                return;
            }
            
            // Group inputs by term for saving
            const termGroups = {};
            allInputs.forEach(input => {
                const term = input.dataset.term;
                if (!termGroups[term]) termGroups[term] = [];
                termGroups[term].push(input);
            });
            
            // Save marks for each term
            Object.keys(termGroups).forEach(term => {
                // Initialize database structure if needed
                if (!database.marks[term]) database.marks[term] = {};
                if (!database.marks[term][studentId]) database.marks[term][studentId] = {};
                
                // Save marks for this term
                termGroups[term].forEach(input => {
                    const subject = input.dataset.subject;
                    const field = input.dataset.field;
                    const value = input.value.trim();
                    
                    if (!database.marks[term][studentId][subject]) {
                        database.marks[term][studentId][subject] = {};
                    }
                    
                    if (field === 'oral' || field === 'written') {
                        if (value.toUpperCase() === 'A') {
                            database.marks[term][studentId][subject][field] = 'A';
                        } else {
                            database.marks[term][studentId][subject][field] = parseInt(value) || 0;
                        }
                        
                        // Set max marks
                        const maxField = field === 'oral' ? 'maxOral' : 'maxWritten';
                        database.marks[term][studentId][subject][maxField] = defaultMaxMarks[term]?.[field] || (field === 'oral' ? 10 : 10);
                        hasChanges = true;
                    }
                });
                
                // Calculate and save total marks for each subject in this term
                subjectOrder.forEach(subject => {
                    if (database.marks[term][studentId][subject]) {
                        const oral = database.marks[term][studentId][subject].oral;
                        const written = database.marks[term][studentId][subject].written;
                        
                        // Set maxTotal
                        const maxOral = database.marks[term][studentId][subject].maxOral || defaultMaxMarks[term]?.oral || 10;
                        const maxWritten = database.marks[term][studentId][subject].maxWritten || defaultMaxMarks[term]?.written || 10;
                        database.marks[term][studentId][subject].maxTotal = maxOral + maxWritten;
                        
                        // Only mark as 'A' if both oral and written are absent
                        if (oral === 'A' && written === 'A') {
                            database.marks[term][studentId][subject].total = 'A';
                        } else {
                            const oralMarks = oral === 'A' ? 0 : (oral || 0);
                            const writtenMarks = written === 'A' ? 0 : (written || 0);
                            database.marks[term][studentId][subject].total = oralMarks + writtenMarks;
                        }
                    }
                });
            });
            
            if (hasChanges) {
                showMessage(document.getElementById('saveMarksNotification'), `âœ… All marks saved successfully for ${studentName} across all terms!`, 'text-green-500');
                displayAdminCombinedMarks(database.students[adminClassSelect.value]?.find(s => s.id === studentId), adminClassSelect.value, studentId); // Refresh the table
            } else {
                showMessage(document.getElementById('saveMarksNotification'), 'âš ï¸ No changes to save!', 'text-orange-500');
            }
        }

        function toggleForm(formId) {
            const forms = ['addStudentForm', 'studentsList', 'addSubjectForm', 'addTermForm', 'manageSubjectsForm'];
            forms.forEach(id => {
                const form = document.getElementById(id);
                if (id === formId) {
                    form.classList.toggle('hidden');
                } else {
                    form.classList.add('hidden');
                }
            });
        }

        function displayStudentsList() {
            const classNum = adminClassSelect.value;
            const students = database.students[classNum] || [];
            
            const studentsTable = document.getElementById('studentsTable');
            studentsTable.innerHTML = `
                <table class="w-full border-collapse border-2 border-purple-300 rounded-lg overflow-hidden">
                    <thead class="bg-purple-500 text-white">
                        <tr>
                            <th class="border-2 border-purple-300 p-3">ID</th>
                            <th class="border-2 border-purple-300 p-3">Student Name</th>
                            <th class="border-2 border-purple-300 p-3">Father's Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr class="hover:bg-purple-50">
                                <td class="border-2 border-purple-300 p-3 text-center">${student.id}</td>
                                <td class="border-2 border-purple-300 p-3">${student.name}</td>
                                <td class="border-2 border-purple-300 p-3">${student.fatherName}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('studentsList').classList.remove('hidden');
        }

        function deleteStudent() {
            const classNum = adminClassSelect.value;
            const studentId = parseInt(adminStudentSelect.value);
            const student = database.students[classNum]?.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found!');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${student.name}?`)) {
                database.students[classNum] = database.students[classNum].filter(s => s.id !== studentId);
                
                Object.keys(database.marks).forEach(term => {
                    if (database.marks[term][studentId]) {
                        delete database.marks[term][studentId];
                    }
                });
                
                updateAdminStudentList();
                document.getElementById('studentMarksTable').classList.add('hidden');
                showMessage(document.getElementById('deleteMessage'), `${student.name} deleted successfully! âœ…`, 'text-green-500');
            }
        }

        function displayAdminCombinedMarks() {
            const classNum = adminClassSelect.value;
            const studentId = parseInt(adminStudentSelect.value);
            
            const student = database.students[classNum]?.find(s => s.id === studentId);
            
            if (!student) {
                document.getElementById('studentMarksTable').classList.add('hidden');
                return;
            }

            // Get all available terms with data for this student
            const availableTerms = Object.keys(database.marks).filter(term => {
                const termMarks = database.marks[term][studentId];
                if (!termMarks) return false;
                
                // Check if any subject has actual marks entered
                return subjectOrder.some(subject => {
                    const mark = termMarks[subject];
                    if (!mark) return false;
                    
                    const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                         (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                         (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                         mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                    
                    return hasActualMarks;
                });
            });

            if (availableTerms.length === 0) {
                const marksTableContainer = document.getElementById('marksTableContainer');
                marksTableContainer.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-xl font-bold text-orange-700">ğŸ‘¦ ${student.name} - Class ${classNum} - ALL TERMS COMBINED</h4>
                        <p class="text-gray-600">ğŸ‘¨ Father: ${student.fatherName}</p>
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-r-lg mt-4">
                            <p class="text-yellow-800">âš ï¸ No marks data available for any term for this student.</p>
                        </div>
                    </div>
                `;
                document.getElementById('studentMarksTable').classList.remove('hidden');
                return;
            }

            // Build combined table structure
            let headerRow = '<th class="border-2 border-orange-300 p-3 text-left">ğŸ“š Subject</th>';
            availableTerms.forEach(term => {
                const termDisplayName = getTermDisplayName(term);
                headerRow += `<th class="border-2 border-orange-300 p-3 text-center" colspan="3">${termDisplayName}</th>`;
            });

            // Create sub-headers for oral, written, total
            let subHeaderRow = '<th class="border-2 border-orange-300 p-2 text-left bg-orange-400"></th>';
            availableTerms.forEach(term => {
                subHeaderRow += '<th class="border-2 border-orange-300 p-2 text-center text-xs bg-orange-400">ğŸ—£ï¸ O</th>';
                subHeaderRow += '<th class="border-2 border-orange-300 p-2 text-center text-xs bg-orange-400">âœï¸ W</th>';
                subHeaderRow += '<th class="border-2 border-orange-300 p-2 text-center text-xs bg-orange-400">ğŸ“Š T</th>';
            });

            const marksTableContainer = document.getElementById('marksTableContainer');
            marksTableContainer.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-orange-700">ğŸ‘¦ ${student.name} - Class ${classNum} - ALL TERMS COMBINED</h4>
                    <p class="text-gray-600">ğŸ‘¨ Father: ${student.fatherName}</p>
                    <div class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg mt-4">
                        <p class="text-blue-800">âš ï¸ <strong>Combined View Mode:</strong> You can edit marks for any term directly in this view. All changes will be saved to their respective terms.</p>
                    </div>
                </div>
                <table class="w-full border-collapse border-2 border-orange-300 rounded-lg overflow-hidden">
                    <thead class="bg-orange-500 text-white">
                        <tr>${headerRow}</tr>
                        <tr>${subHeaderRow}</tr>
                    </thead>
                    <tbody id="combinedMarksTableBody">
                    </tbody>
                </table>
            `;
            
            const tableBody = document.getElementById('combinedMarksTableBody');
            tableBody.innerHTML = '';

            // Process each subject across all terms
            subjectOrder.forEach(subject => {
                let subjectHasData = false;
                let termMarksForSubject = [];

                availableTerms.forEach(term => {
                    const termMarks = database.marks[term][studentId];
                    const mark = termMarks?.[subject];
                    
                    if (mark) {
                        const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                             (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                             (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                             mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                        
                        if (hasActualMarks) {
                            subjectHasData = true;
                            
                            const oralValue = mark.oral ?? '';
                            const writtenValue = mark.written ?? '';
                            const totalValue = mark.total ?? '';
                            const maxOralValue = mark.maxOral ?? defaultMaxMarks[term]?.oral ?? 10;
                            const maxWrittenValue = mark.maxWritten ?? defaultMaxMarks[term]?.written ?? 10;
                            
                            termMarksForSubject.push({
                                term: term,
                                oral: oralValue,
                                written: writtenValue,
                                total: totalValue,
                                maxOral: maxOralValue,
                                maxWritten: maxWrittenValue
                            });
                        } else {
                            termMarksForSubject.push({
                                term: term,
                                oral: '',
                                written: '',
                                total: '',
                                maxOral: defaultMaxMarks[term]?.oral ?? 10,
                                maxWritten: defaultMaxMarks[term]?.written ?? 10
                            });
                        }
                    } else {
                        termMarksForSubject.push({
                            term: term,
                            oral: '',
                            written: '',
                            total: '',
                            maxOral: defaultMaxMarks[term]?.oral ?? 10,
                            maxWritten: defaultMaxMarks[term]?.written ?? 10
                        });
                    }
                });

                // Only show subjects that have data in at least one term
                if (subjectHasData) {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-orange-50 transition-colors duration-200';
                    
                    let rowContent = `<td class="border-2 border-orange-300 p-3 font-semibold">${subject}</td>`;
                    
                    // Add term marks (oral, written, total for each term)
                    termMarksForSubject.forEach(termMark => {
                        rowContent += `
                            <td class="border-2 border-orange-300 p-2 text-center">
                                <input type="text" value="${termMark.oral}" 
                                       data-subject="${subject}" data-field="oral" data-term="${termMark.term}"
                                       class="w-12 p-1 border rounded text-center text-xs" placeholder="0 or A"
                                       onchange="calculateCombinedTotal('${subject}', '${termMark.term}')" title="Enter marks or 'A' for absent">
                            </td>
                            <td class="border-2 border-orange-300 p-2 text-center">
                                <input type="text" value="${termMark.written}" 
                                       data-subject="${subject}" data-field="written" data-term="${termMark.term}"
                                       class="w-12 p-1 border rounded text-center text-xs" placeholder="0 or A"
                                       onchange="calculateCombinedTotal('${subject}', '${termMark.term}')" title="Enter marks or 'A' for absent">
                            </td>
                            <td class="border-2 border-orange-300 p-2 text-center">
                                <input type="text" value="${termMark.total}" 
                                       data-subject="${subject}" data-field="total" data-term="${termMark.term}"
                                       class="w-12 p-1 border rounded text-center bg-gray-100 text-xs" readonly>
                            </td>
                        `;
                    });
                    
                    row.innerHTML = rowContent;
                    tableBody.appendChild(row);
                }
            });

            document.getElementById('studentMarksTable').classList.remove('hidden');
        }

        function displayStudentMarks() {
            const term = adminTermSelect.value;
            const classNum = adminClassSelect.value;
            const studentId = parseInt(adminStudentSelect.value);
            
            const student = database.students[classNum]?.find(s => s.id === studentId);
            const marks = database.marks[term]?.[studentId];
            
            if (!student) {
                document.getElementById('studentMarksTable').classList.add('hidden');
                return;
            }

            const marksTableContainer = document.getElementById('marksTableContainer');
            marksTableContainer.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-xl font-bold text-orange-700">ğŸ‘¦ ${student.name} - Class ${classNum} - ${term.toUpperCase()}</h4>
                    <p class="text-gray-600">ğŸ‘¨ Father: ${student.fatherName}</p>
                </div>
                <table class="w-full border-collapse border-2 border-orange-300 rounded-lg overflow-hidden">
                    <thead class="bg-orange-500 text-white">
                        <tr>
                            <th class="border-2 border-orange-300 p-3 text-left">ğŸ“š Subject</th>
                            <th class="border-2 border-orange-300 p-3 text-center">ğŸ—£ï¸ Oral</th>
                            <th class="border-2 border-orange-300 p-3 text-center">âœï¸ Written</th>
                            <th class="border-2 border-orange-300 p-3 text-center">ğŸ“Š Total</th>
                            <th class="border-2 border-orange-300 p-3 text-center">ğŸ¯ Max Oral</th>
                            <th class="border-2 border-orange-300 p-3 text-center">ğŸ¯ Max Written</th>
                            <th class="border-2 border-orange-300 p-3 text-center">ğŸ¯ Max Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subjectOrder.map(subject => {
                            const mark = marks?.[subject];
                            const defaults = defaultMaxMarks[term] || { oral: 10, written: 10, total: 20 };
                            const oralValue = mark?.oral ?? '';
                            const writtenValue = mark?.written ?? '';
                            const totalValue = mark?.total ?? '';
                            const maxOralValue = mark?.maxOral ?? defaults.oral;
                            const maxWrittenValue = mark?.maxWritten ?? defaults.written;
                            const maxTotalValue = maxOralValue + maxWrittenValue;
                            
                            return `
                                <tr class="hover:bg-orange-50">
                                    <td class="border-2 border-orange-300 p-3 font-semibold">${subject}</td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="text" value="${oralValue}" 
                                               data-subject="${subject}" data-field="oral"
                                               class="w-16 p-1 border rounded text-center" placeholder="0 or A"
                                               onchange="calculateTotal('${subject}')" title="Enter marks or 'A' for absent">
                                    </td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="text" value="${writtenValue}" 
                                               data-subject="${subject}" data-field="written"
                                               class="w-16 p-1 border rounded text-center" placeholder="0 or A"
                                               onchange="calculateTotal('${subject}')" title="Enter marks or 'A' for absent">
                                    </td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="text" value="${totalValue}" 
                                               data-subject="${subject}" data-field="total"
                                               class="w-16 p-1 border rounded text-center bg-gray-100" readonly>
                                    </td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="number" min="1" value="${maxOralValue}" 
                                               data-subject="${subject}" data-field="maxOral"
                                               class="w-16 p-1 border rounded text-center"
                                               onchange="calculateMaxTotal('${subject}')">
                                    </td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="number" min="1" value="${maxWrittenValue}" 
                                               data-subject="${subject}" data-field="maxWritten"
                                               class="w-16 p-1 border rounded text-center"
                                               onchange="calculateMaxTotal('${subject}')">
                                    </td>
                                    <td class="border-2 border-orange-300 p-3 text-center">
                                        <input type="number" min="1" value="${maxTotalValue}" 
                                               data-subject="${subject}" data-field="maxTotal"
                                               class="w-16 p-1 border rounded text-center bg-gray-100" readonly>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('studentMarksTable').classList.remove('hidden');
        }

        // Global functions for inline event handlers
        window.calculateTotal = function(subject) {
            const oralInput = document.querySelector(`input[data-subject="${subject}"][data-field="oral"]`);
            const writtenInput = document.querySelector(`input[data-subject="${subject}"][data-field="written"]`);
            const totalInput = document.querySelector(`input[data-subject="${subject}"][data-field="total"]`);
            const maxOralInput = document.querySelector(`input[data-subject="${subject}"][data-field="maxOral"]`);
            const maxWrittenInput = document.querySelector(`input[data-subject="${subject}"][data-field="maxWritten"]`);
            
            if (!oralInput || !writtenInput || !totalInput || !maxOralInput || !maxWrittenInput) return;
            
            const oral = oralInput.value.toUpperCase() === 'A' ? 'A' : (parseInt(oralInput.value) || 0);
            const written = writtenInput.value.toUpperCase() === 'A' ? 'A' : (parseInt(writtenInput.value) || 0);
            const maxOral = parseInt(maxOralInput.value) || 0;
            const maxWritten = parseInt(maxWrittenInput.value) || 0;
            
            // Remove previous styling
            oralInput.classList.remove('error-input', 'success-input');
            writtenInput.classList.remove('error-input', 'success-input');
            
            // Validate oral marks
            if (oral !== 'A' && oral > maxOral) {
                oralInput.classList.add('error-input');
                totalInput.value = '';
                return;
            }
            
            // Validate written marks
            if (written !== 'A' && written > maxWritten) {
                writtenInput.classList.add('error-input');
                totalInput.value = '';
                return;
            }
            
            // Add success styling for valid inputs
            if (oralInput.value.trim()) oralInput.classList.add('success-input');
            if (writtenInput.value.trim()) writtenInput.classList.add('success-input');
            
            // Calculate total - only show 'A' if both are absent
            if (oral === 'A' && written === 'A') {
                totalInput.value = 'A';
            } else {
                const oralMarks = oral === 'A' ? 0 : oral;
                const writtenMarks = written === 'A' ? 0 : written;
                totalInput.value = oralMarks + writtenMarks;
            }
        };

        window.calculateMaxTotal = function(subject) {
            const maxOralInput = document.querySelector(`input[data-subject="${subject}"][data-field="maxOral"]`);
            const maxWrittenInput = document.querySelector(`input[data-subject="${subject}"][data-field="maxWritten"]`);
            const maxTotalInput = document.querySelector(`input[data-subject="${subject}"][data-field="maxTotal"]`);
            
            if (!maxOralInput || !maxWrittenInput || !maxTotalInput) return;
            
            const maxOral = parseInt(maxOralInput.value) || 0;
            const maxWritten = parseInt(maxWrittenInput.value) || 0;
            
            maxTotalInput.value = maxOral + maxWritten;
        };

        window.calculateCombinedTotal = function(subject, term) {
            const oralInput = document.querySelector(`input[data-subject="${subject}"][data-field="oral"][data-term="${term}"]`);
            const writtenInput = document.querySelector(`input[data-subject="${subject}"][data-field="written"][data-term="${term}"]`);
            const totalInput = document.querySelector(`input[data-subject="${subject}"][data-field="total"][data-term="${term}"]`);
            
            if (!oralInput || !writtenInput || !totalInput) return;
            
            const oral = oralInput.value.toUpperCase() === 'A' ? 'A' : (parseInt(oralInput.value) || 0);
            const written = writtenInput.value.toUpperCase() === 'A' ? 'A' : (parseInt(writtenInput.value) || 0);
            const maxOral = defaultMaxMarks[term]?.oral || 10;
            const maxWritten = defaultMaxMarks[term]?.written || 10;
            
            // Remove previous styling
            oralInput.classList.remove('error-input', 'success-input');
            writtenInput.classList.remove('error-input', 'success-input');
            
            // Validate oral marks
            if (oral !== 'A' && oral > maxOral) {
                oralInput.classList.add('error-input');
                totalInput.value = '';
                return;
            }
            
            // Validate written marks
            if (written !== 'A' && written > maxWritten) {
                writtenInput.classList.add('error-input');
                totalInput.value = '';
                return;
            }
            
            // Add success styling for valid inputs
            if (oralInput.value.trim()) oralInput.classList.add('success-input');
            if (writtenInput.value.trim()) writtenInput.classList.add('success-input');
            
            // Calculate total - only show 'A' if both are absent
            if (oral === 'A' && written === 'A') {
                totalInput.value = 'A';
            } else {
                const oralMarks = oral === 'A' ? 0 : oral;
                const writtenMarks = written === 'A' ? 0 : written;
                totalInput.value = oralMarks + writtenMarks;
            }
        };

        function downloadExcelReport() {
            const classNum = adminClassSelect.value;
            const students = database.students[classNum] || [];
            
            if (students.length === 0) {
                showMessage(document.getElementById('globalMessage'), 'No students found in selected class! âŒ', 'text-red-500');
                return;
            }
            
            // Get all available terms
            const availableTerms = Object.keys(database.marks);
            
            // Create CSV content with professional formatting
            let csvContent = '';
            
            // Header with school information
            csvContent += `PRIMARY SCHOOL KARANPUR\n`;
            csvContent += `Block: Behjam, District: Lakhimpur-Kheri\n`;
            csvContent += `COMPREHENSIVE STUDENT TABULATION SHEET\n`;
            csvContent += `Class: ${classNum}, All Terms\n`;
            csvContent += `Generated on: ${new Date().toLocaleDateString('en-IN')}\n\n`;
            
            // Create headers for all terms
            const headers = ['S.No.', 'Student Name', "Father's Name"];
            
            // Add headers for each term
            availableTerms.forEach(term => {
                headers.push(`${term.toUpperCase()} - Total Marks`);
                headers.push(`${term.toUpperCase()} - Max Marks`);
                headers.push(`${term.toUpperCase()} - Percentage`);
                headers.push(`${term.toUpperCase()} - Grade`);
            });
            
            headers.push('Overall Average %', 'Overall Grade');
            csvContent += headers.join(',') + '\n';
            
            // Process each student
            students.forEach((student, index) => {
                const row = [
                    index + 1,
                    `"${student.name}"`,
                    `"${student.fatherName}"`
                ];
                
                let termPercentages = [];
                
                // Process each term for this student
                availableTerms.forEach(term => {
                    const termMarks = database.marks[term] || {};
                    const marks = termMarks[student.id] || {};
                    
                    let totalObtained = 0;
                    let totalMaximum = 0;
                    
                    // Calculate totals for this term - only for subjects with actual marks entered by admin
                    const subjectsWithData = subjectOrder.filter(subject => {
                        const mark = marks[subject];
                        if (!mark) return false;
                        
                        // Check if marks have been actually entered by admin (not just default values)
                        const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                             (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                             (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                             mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                        
                        return hasActualMarks;
                    });
                    
                    subjectsWithData.forEach(subject => {
                        const mark = marks[subject];
                        if (mark.total !== 'A') {
                            totalObtained += mark.total || 0;
                        }
                        // Use default max marks if maxTotal is undefined
                        const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.total || 20;
                        if (maxTotal && !isNaN(maxTotal)) {
                            totalMaximum += maxTotal;
                        }
                    });
                    
                    const percentage = totalMaximum > 0 ? ((totalObtained / totalMaximum) * 100).toFixed(2) : 0;
                    const grade = getGrade(parseFloat(percentage));
                    
                    if (parseFloat(percentage) > 0) {
                        termPercentages.push(parseFloat(percentage));
                    }
                    
                    row.push(
                        totalObtained || '-',
                        totalMaximum || '-',
                        percentage > 0 ? percentage : '-',
                        percentage > 0 ? grade : '-'
                    );
                });
                
                // Calculate overall average
                const overallAverage = termPercentages.length > 0 
                    ? (termPercentages.reduce((a, b) => a + b, 0) / termPercentages.length).toFixed(2)
                    : 0;
                const overallGrade = getGrade(parseFloat(overallAverage));
                
                row.push(
                    overallAverage > 0 ? overallAverage : '-',
                    overallAverage > 0 ? overallGrade : '-'
                );
                
                csvContent += row.join(',') + '\n';
            });
            
            // Add detailed term-wise breakdown
            csvContent += '\n\nDETAILED TERM-WISE BREAKDOWN\n\n';
            
            availableTerms.forEach(term => {
                csvContent += `${term.toUpperCase()} DETAILED MARKS\n`;
                
                // Get subjects with data for this term (across all students)
                const termSubjectsWithData = new Set();
                students.forEach(student => {
                    const termMarks = database.marks[term] || {};
                    const marks = termMarks[student.id] || {};
                    
                    subjectOrder.forEach(subject => {
                        const mark = marks[subject];
                        if (mark) {
                            // Check if marks have been actually entered by admin (not just default values)
                            const hasActualMarks = (mark.oral !== undefined && mark.oral !== '' && mark.oral !== 0) || 
                                                 (mark.written !== undefined && mark.written !== '' && mark.written !== 0) ||
                                                 (mark.total !== undefined && mark.total !== '' && mark.total !== 0) ||
                                                 mark.oral === 'A' || mark.written === 'A' || mark.total === 'A';
                            
                            if (hasActualMarks) {
                                termSubjectsWithData.add(subject);
                            }
                        }
                    });
                });
                
                const termSubjectsArray = Array.from(termSubjectsWithData);
                
                // Headers for detailed breakdown - only subjects with data
                const detailHeaders = ['S.No.', 'Student Name'];
                termSubjectsArray.forEach(subject => {
                    detailHeaders.push(`${subject} (O)`);
                    detailHeaders.push(`${subject} (W)`);
                    detailHeaders.push(`${subject} (T)`);
                });
                detailHeaders.push('Total', 'Max', '%', 'Grade');
                csvContent += detailHeaders.join(',') + '\n';
                
                // Student data for this term
                students.forEach((student, index) => {
                    const termMarks = database.marks[term] || {};
                    const marks = termMarks[student.id] || {};
                    
                    const detailRow = [index + 1, `"${student.name}"`];
                    
                    let totalObtained = 0;
                    let totalMaximum = 0;
                    
                    termSubjectsArray.forEach(subject => {
                        const mark = marks[subject];
                        if (mark) {
                            const oral = mark.oral === 'A' ? 'A' : (mark.oral || 0);
                            const written = mark.written === 'A' ? 'A' : (mark.written || 0);
                            const total = mark.total === 'A' ? 'A' : (mark.total || 0);
                            
                            detailRow.push(oral, written, total);
                            
                            if (mark.total !== 'A') {
                                totalObtained += mark.total || 0;
                            }
                            // Use default max marks if maxTotal is undefined
                            const maxTotal = mark.maxTotal || defaultMaxMarks[term]?.[classNum]?.total || defaultMaxMarks[term]?.default?.total || 20;
                            if (maxTotal && !isNaN(maxTotal)) {
                                totalMaximum += maxTotal;
                            }
                        } else {
                            detailRow.push('-', '-', '-');
                        }
                    });
                    
                    const percentage = totalMaximum > 0 ? ((totalObtained / totalMaximum) * 100).toFixed(2) : 0;
                    const grade = getGrade(parseFloat(percentage));
                    
                    detailRow.push(
                        totalObtained || '-',
                        totalMaximum || '-',
                        percentage > 0 ? percentage : '-',
                        percentage > 0 ? grade : '-'
                    );
                    
                    csvContent += detailRow.join(',') + '\n';
                });
                
                csvContent += '\n';
            });
            
            // Add class statistics
            csvContent += 'CLASS STATISTICS SUMMARY\n';
            csvContent += `Total Students: ${students.length}\n`;
            csvContent += `Terms Covered: ${availableTerms.join(', ')}\n`;
            csvContent += `Subjects: ${subjectOrder.join(', ')}\n`;
            csvContent += '\n';
            
            csvContent += 'Prepared by: Admin\n';
            csvContent += `Report Generated: ${new Date().toLocaleString('en-IN')}\n`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Class_${classNum}_Complete_Tabulation_Sheet.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage(document.getElementById('globalMessage'), `ğŸ“Š Complete Excel report downloaded successfully for Class ${classNum} (All Terms)!`, 'text-green-600');
            } else {
                showMessage(document.getElementById('globalMessage'), 'âŒ Download not supported in this browser!', 'text-red-500');
            }
        }
        
        function getGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+';
            if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C+';
            if (percentage >= 40) return 'C';
            if (percentage >= 33) return 'D';
            return 'F';
        }

        function displayExistingTerms() {
            const existingTermsList = document.getElementById('existingTermsList');
            const currentTerms = Array.from(adminTermSelect.options)
                .filter(option => option.value !== '')
                .map(option => ({ value: option.value, text: option.textContent }));
            
            if (currentTerms.length === 0) {
                existingTermsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <p class="text-gray-500 text-lg">No terms available to edit</p>
                        <p class="text-gray-400 text-sm mt-2">Create your first term using the form above</p>
                    </div>
                `;
                return;
            }
            
            existingTermsList.innerHTML = currentTerms.map((term, index) => `
                <div class="bg-white rounded-xl p-6 border-2 border-purple-200 shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <span class="bg-purple-100 text-purple-700 font-bold px-3 py-1 rounded-full text-sm mr-3">
                                Term ${index + 1}
                            </span>
                            <span class="text-lg font-bold text-gray-800">${term.text}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">ID: ${term.value}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-bold text-purple-600 mb-2">âœï¸ Edit Term Name:</label>
                                <input type="text" id="edit_${term.value}" value="${term.text}" 
                                       class="w-full p-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none text-lg"
                                       placeholder="Enter new term name">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="updateTermName('${term.value}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center">
                                    âœï¸ Update
                                </button>
                                <button onclick="deleteTerm('${term.value}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center">
                                    ğŸ—‘ï¸ Delete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Maximum Marks Configuration -->
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 border-2 border-dashed border-green-300">
                            <h6 class="text-sm font-bold text-green-700 mb-3 flex items-center">
                                ğŸ¯ Maximum Marks Configuration for ${term.text}
                                <span class="ml-2 text-xs bg-green-200 px-2 py-1 rounded-full">Per Class Settings</span>
                            </h6>
                            
                            <!-- Class Selection for Max Marks -->
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-indigo-600 mb-2">ğŸ“ Select Class for Max Marks Configuration:</label>
                                <select id="maxMarksClass_${term.value}" onchange="loadClassMaxMarks('${term.value}')" 
                                        class="w-full p-2 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                                    <option value="">Choose Class</option>
                                    <option value="1">Class 1</option>
                                    <option value="2">Class 2</option>
                                    <option value="3">Class 3</option>
                                    <option value="4">Class 4</option>
                                    <option value="5">Class 5</option>
                                    <option value="default">Default (All Classes)</option>
                                </select>
                            </div>
                            
                            <div id="maxMarksConfig_${term.value}" class="hidden">
                                <div class="grid md:grid-cols-4 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-bold text-green-600 mb-1">ğŸ—£ï¸ Max Oral:</label>
                                        <input type="number" min="1" max="100" id="maxOral_${term.value}" 
                                               class="w-full p-2 border-2 border-green-300 rounded-lg focus:border-green-500 focus:outline-none text-center"
                                               placeholder="10" onchange="autoCalculateMaxTotal('${term.value}')">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-blue-600 mb-1">âœï¸ Max Written:</label>
                                        <input type="number" min="1" max="100" id="maxWritten_${term.value}" 
                                               class="w-full p-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none text-center"
                                               placeholder="10" onchange="autoCalculateMaxTotal('${term.value}')">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-purple-600 mb-1">ğŸ“Š Total:</label>
                                        <input type="number" id="maxTotal_${term.value}" 
                                               class="w-full p-2 border-2 border-purple-300 rounded-lg bg-gray-100 text-center" readonly>
                                    </div>
                                    <div>
                                        <button onclick="updateMaxMarks('${term.value}')" 
                                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 text-sm">
                                            ğŸ’¾ Save Max
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <button onclick="setQuickMaxMarks('${term.value}', 10, 10)" 
                                            class="text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-2 py-1 rounded transition-colors">
                                        ğŸ“ Unit Test (10+10)
                                    </button>
                                    <button onclick="setQuickMaxMarks('${term.value}', 50, 50)" 
                                            class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition-colors">
                                        ğŸ“š Main Exam (50+50)
                                    </button>
                                    <button onclick="setQuickMaxMarks('${term.value}', 25, 25)" 
                                            class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors">
                                        ğŸ“– Mid Term (25+25)
                                    </button>
                                    <button onclick="setQuickMaxMarks('${term.value}', 20, 30)" 
                                            class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition-colors">
                                        ğŸ“‹ Mixed (20+30)
                                    </button>
                                </div>
                                
                                <!-- Class-specific suggestions -->
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs font-bold text-blue-700 mb-2" id="classSuggestionTitle_${term.value}">ğŸ’¡ Suggestions for selected class:</p>
                                    <div id="classSuggestions_${term.value}" class="flex flex-wrap gap-2">
                                        <!-- Dynamic suggestions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick rename suggestions -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-600 mb-2">ğŸ’¡ Quick rename suggestions:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="document.getElementById('edit_${term.value}').value='Half Yearly Exam'" 
                                    class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition-colors">
                                Half Yearly Exam
                            </button>
                            <button onclick="document.getElementById('edit_${term.value}').value='Annual Exam'" 
                                    class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors">
                                Annual Exam
                            </button>
                            <button onclick="document.getElementById('edit_${term.value}').value='Unit Test ${index + 1}'" 
                                    class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded transition-colors">
                                Unit Test ${index + 1}
                            </button>
                            <button onclick="document.getElementById('edit_${term.value}').value='Monthly Test ${index + 1}'" 
                                    class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition-colors">
                                Monthly Test ${index + 1}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Quick add term function
        window.quickAddTerm = function(termName) {
            document.getElementById('newTermName').value = termName;
            document.getElementById('newTermName').focus();
        };

        // Display subjects list with drag and drop functionality
        function displaySubjectsList() {
            const subjectsList = document.getElementById('subjectsList');
            
            if (subjectOrder.length === 0) {
                subjectsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">ğŸ“š</div>
                        <p class="text-gray-500 text-lg">No subjects available</p>
                        <p class="text-gray-400 text-sm mt-2">Add your first subject using the form on the right</p>
                    </div>
                `;
                return;
            }
            
            subjectsList.innerHTML = subjectOrder.map((subject, index) => `
                <div class="subject-item bg-white rounded-xl p-4 border-2 border-blue-200 shadow-lg hover:shadow-xl transition-all duration-300 cursor-move" 
                     data-subject="${subject}" draggable="true">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded-full text-sm mr-3">
                                ${index + 1}
                            </span>
                            <span class="text-lg font-bold text-gray-800">${subject}</span>
                            <span class="ml-3 text-gray-400 cursor-move">â‹®â‹®</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="moveSubjectUp('${subject}')" 
                                    class="bg-green-100 hover:bg-green-200 text-green-700 font-bold px-2 py-1 rounded text-sm transition-colors"
                                    title="Move Up">
                                â†‘
                            </button>
                            <button onclick="moveSubjectDown('${subject}')" 
                                    class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold px-2 py-1 rounded text-sm transition-colors"
                                    title="Move Down">
                                â†“
                            </button>
                            <button onclick="removeSubject('${subject}')" 
                                    class="bg-red-100 hover:bg-red-200 text-red-700 font-bold px-2 py-1 rounded text-sm transition-colors"
                                    title="Remove Subject">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add drag and drop functionality
            addDragAndDropToSubjects();
        }

        // Add drag and drop functionality to subjects
        function addDragAndDropToSubjects() {
            const subjectItems = document.querySelectorAll('.subject-item');
            let draggedElement = null;
            
            subjectItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    item.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                    draggedElement = null;
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item) {
                        const draggedSubject = draggedElement.dataset.subject;
                        const targetSubject = item.dataset.subject;
                        
                        const draggedIndex = subjectOrder.indexOf(draggedSubject);
                        const targetIndex = subjectOrder.indexOf(targetSubject);
                        
                        // Remove dragged subject from its current position
                        subjectOrder.splice(draggedIndex, 1);
                        
                        // Insert at new position
                        const newTargetIndex = subjectOrder.indexOf(targetSubject);
                        subjectOrder.splice(newTargetIndex, 0, draggedSubject);
                        
                        displaySubjectsList();
                    }
                });
            });
        }

        // Quick add subject function
        window.quickAddSubject = function(subjectName) {
            if (!subjectOrder.includes(subjectName)) {
                subjectOrder.push(subjectName);
                displaySubjectsList();
                showMessage(document.getElementById('globalMessage'), `âœ… Subject "${subjectName}" added successfully!`, 'text-green-500');
                
                if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                    displayStudentMarks();
                }
            } else {
                showMessage(document.getElementById('globalMessage'), `âŒ Subject "${subjectName}" already exists!`, 'text-red-500');
            }
        };

        // Move subject up in order
        window.moveSubjectUp = function(subject) {
            const index = subjectOrder.indexOf(subject);
            if (index > 0) {
                [subjectOrder[index], subjectOrder[index - 1]] = [subjectOrder[index - 1], subjectOrder[index]];
                displaySubjectsList();
            }
        };

        // Move subject down in order
        window.moveSubjectDown = function(subject) {
            const index = subjectOrder.indexOf(subject);
            if (index < subjectOrder.length - 1) {
                [subjectOrder[index], subjectOrder[index + 1]] = [subjectOrder[index + 1], subjectOrder[index]];
                displaySubjectsList();
            }
        };

        // Remove subject
        window.removeSubject = function(subject) {
            if (confirm(`Are you sure you want to remove "${subject}"?\n\nWarning: This will delete all marks data for this subject across all terms and students!`)) {
                // Remove from subject order
                const index = subjectOrder.indexOf(subject);
                if (index > -1) {
                    subjectOrder.splice(index, 1);
                }
                
                // Remove marks data for this subject from all terms and students
                Object.keys(database.marks).forEach(term => {
                    Object.keys(database.marks[term]).forEach(studentId => {
                        if (database.marks[term][studentId][subject]) {
                            delete database.marks[term][studentId][subject];
                        }
                    });
                });
                
                displaySubjectsList();
                showMessage(document.getElementById('globalMessage'), `ğŸ—‘ï¸ Subject "${subject}" removed successfully!`, 'text-red-500');
                
                // Refresh marks table if currently viewing
                if (adminTermSelect.value && adminClassSelect.value && adminStudentSelect.value) {
                    displayStudentMarks();
                }
            }
        };

        // Update student message display
        function updateStudentMessageDisplay() {
            document.getElementById('studentTileTitle').textContent = studentTileTitle;
            document.getElementById('studentMessage').textContent = studentCustomMessage;
            
            const instructionsDiv = document.getElementById('additionalInstructionsDiv');
            const instructionsText = document.getElementById('additionalInstructionsText');
            
            if (studentAdditionalInstructions) {
                instructionsText.textContent = studentAdditionalInstructions;
                instructionsDiv.classList.remove('hidden');
            } else {
                instructionsDiv.classList.add('hidden');
            }
        }

        // Quick message setter
        window.setQuickMessage = function(title, message) {
            document.getElementById('customTileTitle').value = title;
            document.getElementById('customMessage').value = message;
        };

        // Global functions for term management
        window.updateTermName = function(termValue) {
            const newNameInput = document.getElementById(`edit_${termValue}`);
            const newDisplayName = newNameInput.value.trim();
            
            if (!newDisplayName) {
                alert('Please enter a valid term name!');
                return;
            }
            
            // Update admin dropdown
            const adminOption = Array.from(adminTermSelect.options).find(opt => opt.value === termValue);
            if (adminOption) {
                adminOption.textContent = newDisplayName;
            }
            
            // Update student view control dropdown
            const studentViewOption = Array.from(document.getElementById('studentViewTermSelect').options).find(opt => opt.value === termValue);
            if (studentViewOption) {
                studentViewOption.textContent = newDisplayName;
            }
            
            // Update active term display if this is the active term
            if (activeTermForStudents === termValue) {
                document.getElementById('currentActiveTerm').textContent = newDisplayName;
                document.getElementById('activeTermName').textContent = newDisplayName;
            }
            
            showMessage(document.getElementById('globalMessage'), `âœ… Term name updated to "${newDisplayName}"!`, 'text-green-500');
            displayExistingTerms();
        };

        // Load class-specific maximum marks configuration
        window.loadClassMaxMarks = function(termValue) {
            const classSelect = document.getElementById(`maxMarksClass_${termValue}`);
            const configDiv = document.getElementById(`maxMarksConfig_${termValue}`);
            const maxOralInput = document.getElementById(`maxOral_${termValue}`);
            const maxWrittenInput = document.getElementById(`maxWritten_${termValue}`);
            const maxTotalInput = document.getElementById(`maxTotal_${termValue}`);
            const suggestionsDiv = document.getElementById(`classSuggestions_${termValue}`);
            const suggestionTitle = document.getElementById(`classSuggestionTitle_${termValue}`);
            
            const selectedClass = classSelect.value;
            
            if (!selectedClass) {
                configDiv.classList.add('hidden');
                return;
            }
            
            configDiv.classList.remove('hidden');
            
            // Load current values for the selected class
            const currentMarks = defaultMaxMarks[termValue]?.[selectedClass] || 
                               defaultMaxMarks[termValue]?.default || 
                               { oral: 10, written: 10, total: 20 };
            
            maxOralInput.value = currentMarks.oral;
            maxWrittenInput.value = currentMarks.written;
            maxTotalInput.value = currentMarks.total;
            
            // Update suggestion title and load class-specific suggestions
            if (selectedClass === 'default') {
                suggestionTitle.textContent = 'ğŸ’¡ Default suggestions for all classes:';
                suggestionsDiv.innerHTML = `
                    <button onclick="setQuickMaxMarks('${termValue}', 15, 15)" 
                            class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded transition-colors">
                        ğŸ“š Standard (15+15)
                    </button>
                    <button onclick="setQuickMaxMarks('${termValue}', 20, 20)" 
                            class="text-xs bg-teal-100 hover:bg-teal-200 text-teal-700 px-2 py-1 rounded transition-colors">
                        ğŸ“– Moderate (20+20)
                    </button>
                    <button onclick="setQuickMaxMarks('${termValue}', 30, 30)" 
                            class="text-xs bg-cyan-100 hover:bg-cyan-200 text-cyan-700 px-2 py-1 rounded transition-colors">
                        ğŸ“Š Advanced (30+30)
                    </button>
                `;
            } else {
                suggestionTitle.textContent = `ğŸ’¡ Suggestions for Class ${selectedClass}:`;
                
                // Class-specific suggestions based on grade level
                let suggestions = '';
                if (selectedClass === '1' || selectedClass === '2') {
                    suggestions = `
                        <button onclick="setQuickMaxMarks('${termValue}', 5, 5)" 
                                class="text-xs bg-pink-100 hover:bg-pink-200 text-pink-700 px-2 py-1 rounded transition-colors">
                            ğŸŒŸ Beginner (5+5)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 10, 10)" 
                                class="text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-2 py-1 rounded transition-colors">
                            ğŸ“ Basic (10+10)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 15, 15)" 
                                class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors">
                            ğŸ“š Standard (15+15)
                        </button>
                    `;
                } else if (selectedClass === '3') {
                    suggestions = `
                        <button onclick="setQuickMaxMarks('${termValue}', 15, 15)" 
                                class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition-colors">
                            ğŸ“š Standard (15+15)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 20, 20)" 
                                class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-2 py-1 rounded transition-colors">
                            ğŸ“– Intermediate (20+20)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 25, 25)" 
                                class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-2 py-1 rounded transition-colors">
                            ğŸ¯ Advanced (25+25)
                        </button>
                    `;
                } else if (selectedClass === '4' || selectedClass === '5') {
                    suggestions = `
                        <button onclick="setQuickMaxMarks('${termValue}', 25, 25)" 
                                class="text-xs bg-teal-100 hover:bg-teal-200 text-teal-700 px-2 py-1 rounded transition-colors">
                            ğŸ“– Standard (25+25)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 35, 35)" 
                                class="text-xs bg-cyan-100 hover:bg-cyan-200 text-cyan-700 px-2 py-1 rounded transition-colors">
                            ğŸ¯ Intermediate (35+35)
                        </button>
                        <button onclick="setQuickMaxMarks('${termValue}', 50, 50)" 
                                class="text-xs bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-2 py-1 rounded transition-colors">
                            ğŸ† Advanced (50+50)
                        </button>
                    `;
                }
                suggestionsDiv.innerHTML = suggestions;
            }
        };

        // Update maximum marks for a term and class
        window.updateMaxMarks = function(termValue) {
            const classSelect = document.getElementById(`maxMarksClass_${termValue}`);
            const maxOralInput = document.getElementById(`maxOral_${termValue}`);
            const maxWrittenInput = document.getElementById(`maxWritten_${termValue}`);
            const maxTotalInput = document.getElementById(`maxTotal_${termValue}`);
            
            const selectedClass = classSelect.value;
            const maxOral = parseInt(maxOralInput.value) || 10;
            const maxWritten = parseInt(maxWrittenInput.value) || 10;
            const maxTotal = maxOral + maxWritten;
            
            if (!selectedClass) {
                alert('Please select a class first!');
                return;
            }
            
            // Validate inputs
            if (maxOral < 1 || maxOral > 100) {
                alert('Max Oral marks must be between 1 and 100!');
                maxOralInput.focus();
                return;
            }
            
            if (maxWritten < 1 || maxWritten > 100) {
                alert('Max Written marks must be between 1 and 100!');
                maxWrittenInput.focus();
                return;
            }
            
            // Initialize term structure if needed
            if (!defaultMaxMarks[termValue]) {
                defaultMaxMarks[termValue] = {};
            }
            
            // Update the default max marks for this term and class
            defaultMaxMarks[termValue][selectedClass] = {
                oral: maxOral,
                written: maxWritten,
                total: maxTotal
            };
            
            // Update the total field
            maxTotalInput.value = maxTotal;
            
            // Update existing student marks with new max marks if they don't have custom max marks
            Object.keys(database.marks).forEach(term => {
                if (term === termValue && database.marks[term]) {
                    Object.keys(database.marks[term]).forEach(studentId => {
                        // Find which class this student belongs to
                        let studentClass = null;
                        Object.keys(database.students).forEach(classNum => {
                            if (database.students[classNum].find(s => s.id == studentId)) {
                                studentClass = classNum;
                            }
                        });
                        
                        // Only update if this student is in the selected class (or if default is selected)
                        if (selectedClass === 'default' || studentClass === selectedClass) {
                            const studentMarks = database.marks[term][studentId];
                            Object.keys(studentMarks).forEach(subject => {
                                const mark = studentMarks[subject];
                                // Only update if the mark doesn't have custom max marks set
                                if (!mark.maxOral || !mark.maxWritten || !mark.maxTotal) {
                                    mark.maxOral = maxOral;
                                    mark.maxWritten = maxWritten;
                                    mark.maxTotal = maxTotal;
                                }
                            });
                        }
                    });
                }
            });
            
            const termName = Array.from(adminTermSelect.options).find(opt => opt.value === termValue)?.textContent || termValue;
            const classText = selectedClass === 'default' ? 'All Classes' : `Class ${selectedClass}`;
            showMessage(document.getElementById('globalMessage'), `ğŸ¯ Maximum marks updated for "${termName}" - ${classText}: Oral=${maxOral}, Written=${maxWritten}, Total=${maxTotal}`, 'text-green-500');
            
            // Refresh marks table if currently viewing this term and class
            if (adminTermSelect.value === termValue && adminClassSelect.value === selectedClass && adminStudentSelect.value) {
                displayStudentMarks();
            }
        };

        // Set quick maximum marks presets
        window.setQuickMaxMarks = function(termValue, oral, written) {
            const maxOralInput = document.getElementById(`maxOral_${termValue}`);
            const maxWrittenInput = document.getElementById(`maxWritten_${termValue}`);
            const maxTotalInput = document.getElementById(`maxTotal_${termValue}`);
            
            maxOralInput.value = oral;
            maxWrittenInput.value = written;
            maxTotalInput.value = oral + written;
            
            // Auto-save the changes
            updateMaxMarks(termValue);
        };

        // Auto-calculate total when oral or written marks change
        window.autoCalculateMaxTotal = function(termValue) {
            const maxOralInput = document.getElementById(`maxOral_${termValue}`);
            const maxWrittenInput = document.getElementById(`maxWritten_${termValue}`);
            const maxTotalInput = document.getElementById(`maxTotal_${termValue}`);
            
            const maxOral = parseInt(maxOralInput.value) || 0;
            const maxWritten = parseInt(maxWrittenInput.value) || 0;
            const maxTotal = maxOral + maxWritten;
            
            maxTotalInput.value = maxTotal;
        };

        window.deleteTerm = function(termValue) {
            const termOption = Array.from(adminTermSelect.options).find(opt => opt.value === termValue);
            const termName = termOption ? termOption.textContent : termValue;
            
            if (!confirm(`Are you sure you want to delete "${termName}"?\n\nWarning: This will also delete all marks data for this term!`)) {
                return;
            }
            
            // Remove from admin dropdown
            const adminOption = Array.from(adminTermSelect.options).find(opt => opt.value === termValue);
            if (adminOption) {
                adminOption.remove();
            }
            
            // Remove from student view control dropdown
            const studentViewOption = Array.from(document.getElementById('studentViewTermSelect').options).find(opt => opt.value === termValue);
            if (studentViewOption) {
                studentViewOption.remove();
            }
            
            // Delete marks data
            if (database.marks[termValue]) {
                delete database.marks[termValue];
            }
            
            // Reset selections if deleted term was selected
            if (adminTermSelect.value === termValue) {
                adminTermSelect.value = '';
                updateAdminStudentList();
            }
            if (activeTermForStudents === termValue) {
                activeTermForStudents = '';
                document.getElementById('currentActiveTerm').textContent = 'None';
                document.getElementById('activeTermName').textContent = '';
                document.getElementById('studentViewTermSelect').value = '';
                reportCard.classList.add('hidden');
            }
            
            showMessage(document.getElementById('globalMessage'), `ğŸ—‘ï¸ Term "${termName}" deleted successfully!`, 'text-red-500');
            displayExistingTerms();
        };

        function showMessage(element, message, className) {
            if (!element) return;
            element.textContent = message;
            element.className = `message ${className} show`;
            setTimeout(() => {
                element.classList.remove('show');
            }, 3000);
        }

        // Initialize
        updateStudentMessageDisplay();
        studentBtn.click();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b60e8581104850',t:'MTc1NzI0NjU0Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
